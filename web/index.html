<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawChat - OpenClaw Â∞çË©±‰ªãÈù¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    * { box-sizing: border-box; }
    html, body, #app { height: 100%; margin: 0; padding: 0; }
    body { background: #0f0f0f; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    
    /* Message animations */
    .message-enter-active { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Typing indicator */
    .typing-dot { animation: bounce 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    
    /* Agent selector dropdown */
    :root {
      --bg-primary: #161616;
      --bg-secondary: #1f1f1f;
      --bg-hover: #252525;
      --border-color: #333;
      --text-primary: #fff;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
    }
    
    .light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-hover: #f3f4f6;
      --border-color: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #374151;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
    }
    
    #app {
      background-color: var(--bg-primary, #161616);
      min-height: 100vh;
    }
    
    #app aside {
      background-color: var(--bg-primary, #161616) !important;
      border-color: var(--border-color, #333) !important;
    }
    
    #app main {
      background-color: var(--bg-primary, #161616);
    }
    
    /* Dark/Light backgrounds */
    #app .bg-\[#161616\] { background-color: var(--bg-primary) !important; }
    #app .bg-\[#1f1f1f\] { background-color: var(--bg-secondary) !important; }
    #app .bg-\[#252525\] { background-color: var(--bg-hover) !important; }
    #app .bg-\[#2a2a2a\] { background-color: var(--bg-hover) !important; }
    #app .border-\[#333\] { border-color: var(--border-color) !important; }
    
    /* Text colors */
    #app .text-gray-400 { color: var(--text-secondary) !important; }
    #app .text-gray-500 { color: var(--text-muted) !important; }
    #app .text-gray-300 { color: var(--text-secondary) !important; }
    #app .text-gray-600 { color: var(--text-secondary) !important; }
    #app .text-white { color: var(--text-primary) !important; }
    #app .text-gray-700 { color: var(--text-primary) !important; }
    #app .hover\:text-white:hover { color: var(--text-primary) !important; }
    
    /* Hover states */
    #app .hover\:bg-\[#252525\]\:hover:hover { background-color: var(--bg-hover) !important; }
    #app .hover\:bg-\[#2a2a2a\]\:hover:hover { background-color: var(--bg-hover) !important; }
    #app .bg-gray-200 { background-color: var(--bg-secondary) !important; }
    #app .hover\:bg-gray-300\:hover:hover { background-color: var(--bg-hover) !important; }
    
    /* Input fields */
    #app input, #app textarea { 
      background-color: var(--bg-secondary) !important; 
      color: var(--text-primary) !important; 
      border-color: var(--border-color) !important; 
    }
    #app input::placeholder, #app textarea::placeholder { 
      color: var(--text-muted) !important; 
    }
    
    /* Buttons */
    #app button {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    /* Agent dropdown */
    #app .agent-dropdown {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-color) !important;
    }
    
    /* Modal/Preview */
    #app .fixed .bg-\[\#1f1f1f\] {
      background-color: var(--bg-secondary) !important;
    }
    
    /* Cards */
    #app .rounded-lg {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
    }
    
    .agent-dropdown { max-height: 300px; overflow-y: auto; }
    
    /* Markdown preview styles */
    .markdown-body { line-height: 1.6; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--text-primary); margin: 1em 0 0.5em; font-weight: bold; }
    .markdown-body h1 { font-size: 1.5em; }
    .markdown-body h2 { font-size: 1.3em; }
    .markdown-body h3 { font-size: 1.1em; }
    .markdown-body p { margin: 0.5em 0; }
    .markdown-body p:last-child { margin-bottom: 0; }
    .markdown-body code { background: var(--bg-hover); padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; }
    .markdown-body pre { background: var(--bg-hover); padding: 1em; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
    .markdown-body pre code { background: none; padding: 0; }
    .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin: 0.5em 0; }
    .markdown-body li { margin: 0.25em 0; }
    .markdown-body li > ul, .markdown-body li > ol { margin: 0.25em 0; }
    .markdown-body blockquote { border-left: 3px solid var(--accent); padding-left: 1em; color: var(--text-muted); margin: 0.5em 0; }
    .markdown-body a { color: var(--accent); text-decoration: underline; }
    .markdown-body a:hover { color: var(--accent-hover); }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
    .markdown-body th, .markdown-body td { border: 1px solid var(--border-color); padding: 0.5em; text-align: left; }
    .markdown-body th { background: var(--bg-hover); }
    .markdown-body hr { border: none; border-top: 1px solid var(--border-color); margin: 1em 0; }
    .markdown-body img { max-width: 100%; border-radius: 6px; margin: 0.5em 0; }
    .markdown-body strong { color: var(--text-primary); font-weight: bold; }
    .markdown-body em { font-style: italic; }
  </style>
</head>
<body>
  <div id="app">
    <div class="flex h-full">
      
      <!-- ÂÅ¥ÈÇäÊ¨ÑÔºöAgent ÈÅ∏ÊìáÂô® -->
      <aside class="w-72 bg-[#161616] border-r flex flex-col">
        <!-- Logo + È†ÅÁ±§ÂàáÊèõ -->
        <div class="p-4 border-b">
          <div class="flex gap-2 mb-3">
            <button 
              @click="currentView = 'chat'"
              class="flex-1 py-2 rounded-lg text-sm font-medium transition-colors"
              :class="currentView === 'chat' ? 'bg-[#2563eb] text-white' : 'bg-[#1f1f1f] text-gray-400 hover:text-white'"
            >
              <i class="bi bi-chat-dots me-1"></i> Â∞çË©±
            </button>
            <button 
              @click="currentView = 'manage'"
              class="flex-1 py-2 rounded-lg text-sm font-medium transition-colors"
              :class="currentView === 'manage' ? 'bg-[#2563eb] text-white' : 'bg-[#1f1f1f] text-gray-400 hover:text-white'"
            >
              <i class="bi bi-gear me-1"></i> ÁÆ°ÁêÜ
            </button>
            <!-- ‰∏ªÈ°åÂàáÊèõ -->
            <button 
              @click="toggleTheme"
              class="p-2 rounded-lg transition-colors"
              :class="isDarkMode ? 'bg-[#1f1f1f] text-yellow-400 hover:bg-[#252525]' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
              :title="isDarkMode ? 'ÂàáÊèõÂà∞ÁôΩÂ§©Ê®°Âºè' : 'ÂàáÊèõÂà∞Â§úÊôöÊ®°Âºè'"
            >
              <i class="bi" :class="isDarkMode ? 'bi-sun' : 'bi-moon'"></i>
            </button>
          </div>
          <h1 v-if="currentView === 'chat'" class="text-xl font-bold flex items-center gap-2" :style="{ color: isDarkMode ? '#fff' : '#111827' }">
            <span class="text-2xl">üí¨</span>
            <span>ClawChat</span>
          </h1>
        </div>
        

        
        <!-- Agent ÈÅ∏Êìá (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4">
          <label class="text-xs text-gray-500 uppercase tracking-wider">ÈÅ∏Êìá Agent</label>
          <div class="relative mt-2">
            <button 
              @click="showAgentDropdown = !showAgentDropdown"
              class="w-full bg-[#1f1f1f] hover:bg-[#252525] border rounded-lg p-3 flex items-center gap-3 transition-colors"
            >
              <span class="text-2xl">{{ selectedAgent.identity.emoji }}</span>
              <div class="text-left flex-1">
                <div class="font-medium">{{ selectedAgent.identity.name }}</div>
                <div class="text-xs text-gray-500">{{ selectedAgent.name }}</div>
              </div>
              <i class="bi bi-chevron-down text-gray-500"></i>
            </button>
            
            <!-- Dropdown -->
            <div v-if="showAgentDropdown" class="agent-dropdown absolute top-full left-0 right-0 mt-1 bg-[#1f1f1f] border rounded-lg shadow-xl z-50">
              <button
                v-for="agent in agents"
                :key="agent.id"
                @click="selectAgent(agent)"
                class="w-full p-3 flex items-center gap-3 hover:bg-[#2a2a2a] transition-colors"
                :class="{'bg-[#252525]': agent.id === selectedAgent.id}"
              >
                <span class="text-2xl">{{ agent.identity.emoji }}</span>
                <div class="text-left flex-1">
                  <div class="font-medium">{{ agent.identity.name }}</div>
                  <div class="text-xs text-gray-500">{{ agent.name }}</div>
                </div>
                <i v-if="agent.id === selectedAgent.id" class="bi bi-check text-green-500"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Session ÊéßÂà∂ (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 border-t">
          <label class="text-xs text-gray-500 uppercase tracking-wider">Â∞çË©±</label>
          <div class="relative mt-2">
            <button 
              @click="showSessionDropdown = !showSessionDropdown"
              class="w-full bg-[#1f1f1f] hover:bg-[#252525] border rounded-lg p-2 flex items-center gap-2 transition-colors text-sm"
            >
              <i class="bi bi-chat-dots text-gray-400"></i>
              <span class="flex-1 text-left truncate">{{ currentSessionName }}</span>
              <i class="bi bi-chevron-down text-gray-500 text-xs"></i>
            </button>
            
            <!-- Session Dropdown -->
            <div v-if="showSessionDropdown" class="absolute top-full left-0 right-0 mt-1 bg-[#1f1f1f] border rounded-lg shadow-xl z-50">
              <div class="p-2 border-b">
                <button
                  @click="createNewSession"
                  class="w-full p-2 text-sm text-blue-400 hover:bg-[#2a2a2a] rounded flex items-center gap-2"
                >
                  <i class="bi bi-plus-circle"></i>
                  <span>Êñ∞Â∞çË©±</span>
                </button>
              </div>
              <button
                v-for="session in sessions"
                :key="session.id"
                @click="switchSession(session)"
                class="w-full p-2 text-sm hover:bg-[#2a2a2a] transition-colors flex items-center gap-2"
                :class="{'bg-[#252525]': session.id === currentSession}"
              >
                <i class="bi bi-chat-dots text-gray-500"></i>
                <div class="flex-1 text-left overflow-hidden">
                  <div class="truncate">{{ session.name }}</div>
                  <div v-if="session.preview" class="text-xs text-gray-500 truncate">{{ session.preview }}</div>
                </div>
                <i v-if="session.id === currentSession" class="bi bi-check text-green-500"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Ê®°ÂûãÈÅ∏Êìá (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 border-t">
          <label class="text-xs text-gray-500 uppercase tracking-wider">Ê®°Âûã</label>
          <select 
            v-model="selectedModel" 
            class="mt-2 w-full bg-[#1f1f1f] border rounded-lg p-2 text-sm"
          >
            <option v-for="model in models" :key="model.id" :value="model.id">
              {{ model.name }}
            </option>
          </select>
        </div>
        
        <!-- Ê™îÊ°àÁÄèË¶ΩÂô® (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 border-t flex-1 overflow-hidden flex flex-col">
          <button 
            @click="toggleFileBrowser"
            class="w-full flex items-center justify-between text-xs text-gray-500 uppercase tracking-wider mb-2"
          >
            <span><i class="bi bi-folder me-1"></i> Workspace Ê™îÊ°à</span>
            <i class="bi" :class="showFileBrowser ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>
          
          <!-- Ê™îÊ°àÂàóË°® -->
          <div v-if="showFileBrowser" class="flex-1 overflow-y-auto space-y-1">
            <!-- ËºâÂÖ•‰∏≠ -->
            <div v-if="fileBrowserLoading" class="text-center text-gray-500 text-sm py-4">
              <i class="bi bi-hourglass-split animate-spin"></i> ËºâÂÖ•‰∏≠...
            </div>
            
            <!-- È∫µÂåÖÂ±ëÂ∞éËà™ -->
            <div v-if="fileBrowserPath.length > 0" class="flex items-center gap-1 mb-2 overflow-x-auto">
              <button @click="fileBrowserNavigate('')" class="text-xs text-blue-400 hover:text-blue-300 whitespace-nowrap">
                <i class="bi bi-house"></i> Ê†πÁõÆÈåÑ
              </button>
              <span v-for="(p, idx) in fileBrowserPath" :key="idx" class="flex items-center gap-1">
                <span class="text-gray-600">/</span>
                <button @click="fileBrowserNavigate(fileBrowserPath.slice(0, idx + 1).join('/'))" class="text-xs text-blue-400 hover:text-blue-300 whitespace-nowrap">
                  {{ p }}
                </button>
              </span>
            </div>
            
            <!-- Ê™îÊ°à/Ë≥áÊñôÂ§æÂàóË°® -->
            <div v-if="!fileBrowserLoading && fileBrowserFiles.length === 0" class="text-center text-gray-500 text-xs py-2">
              Ê≤íÊúâÊ™îÊ°à
            </div>
            <button
              v-for="file in fileBrowserFiles"
              :key="file.path"
              @click="file.type === 'directory' ? fileBrowserNavigate(fileBrowserPath.length > 0 ? fileBrowserPath.join('/') + '/' + file.path : file.path) : openFile(file)"
              class="w-full p-2 text-left flex items-center gap-2 hover:bg-[#2a2a2a] rounded text-sm transition-colors"
            >
              <i class="bi" :class="file.type === 'directory' ? 'bi-folder' : 'bi-file-text'"></i>
              <span class="truncate">{{ file.name }}</span>
              <span v-if="file.type === 'file'" class="text-xs text-gray-600 ml-auto">
                {{ formatFileSize(file.size) }}
              </span>
            </button>
          </div>
          
          <!-- Ê™îÊ°àÈ†êË¶ΩÂΩàÁ™ó -->
          <div v-if="filePreviewContent !== null" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" @click.self="filePreviewContent = null">
            <div class="bg-[#1f1f1f] rounded-lg w-full max-w-3xl max-h-[80vh] flex flex-col border">
              <div class="p-3 border-b flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="bi bi-file-text"></i>
                  <span class="font-medium">{{ filePreviewPath }}</span>
                </div>
                <button @click="filePreviewContent = null" class="text-gray-400 hover:text-white">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              <div class="flex-1 overflow-auto p-3">
                <!-- ÂúñÁâáÈ†êË¶Ω -->
                <div v-if="filePreviewImage" class="flex justify-center">
                  <img :src="filePreviewImage" class="max-w-full max-h-[70vh] object-contain rounded-lg" />
                </div>
                <!-- Markdown È†êË¶Ω -->
                <div v-else-if="isMarkdownFile(filePreviewPath)" class="markdown-body text-sm text-gray-300" v-html="renderMarkdown(filePreviewContent)"></div>
                <!-- Á¥îÊñáÂ≠óÈ†êË¶Ω -->
                <pre v-else class="text-xs text-gray-300 whitespace-pre-wrap">{{ filePreviewContent }}</pre>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Âø´Êç∑Êìç‰Ωú (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 border-t mt-auto">
          <button 
            @click="clearChat"
            class="w-full p-2 text-gray-400 hover:text-white hover:bg-[#2a2a2a] rounded-lg flex items-center justify-center gap-2 transition-colors"
          >
            <i class="bi bi-trash"></i>
            <span>Ê∏ÖÁ©∫Â∞çË©±</span>
          </button>
        </div>
      </aside>
      
      <!-- ‰∏ªÂçÄÂüü -->
      <main class="flex-1 flex flex-col">
        <!-- ÁÆ°ÁêÜÈ†ÅÈù¢ÂÖßÂÆπ (‰∏ªÂçÄÂüü) -->
        <div v-if="currentView === 'manage'" class="flex-1 overflow-y-auto p-4">
          <!-- ÂàóË°®Ë¶ñÂúñ -->
          <div v-if="!detailView">
            <!-- ÁãÄÊÖãÂç°Áâá -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Á≥ªÁµ±ÁãÄÊÖã</h3>
              <div class="bg-[#1f1f1f] rounded-lg p-4 border space-y-3">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full" :class="systemStatus === 'online' ? 'bg-green-500' : 'bg-red-500'"></div>
                  <span class="font-medium">Gateway {{ systemStatus }}</span>
                </div>
                
                <!-- ngrok -->
                <div v-if="ngrokUrl" class="pt-3 border-t">
                  <div class="text-xs text-gray-500 mb-2">ÂÖ¨ÈñãÁ∂≤ÂùÄ</div>
                  <a :href="ngrokUrl" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm break-all">
                    {{ ngrokUrl }}
                  </a>
                </div>
                <div v-else class="pt-3 border-t">
                  <button 
                    @click="startNgrok"
                    class="w-full py-2 bg-[#2563eb] hover:bg-[#1d4ed8] rounded-lg text-sm transition-colors"
                  >
                    <i class="bi bi-box-arrow-up-right me-1"></i> ÂïüÂãï ngrok
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Agents ÂàóË°® -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Agents ({{ manageAgents.length }})</h3>
              <div class="space-y-2">
                <button 
                  v-for="agent in manageAgents" 
                  :key="agent.id"
                  @click="showAgentDetail(agent)"
                  class="w-full bg-[#1f1f1f] hover:bg-[#252525] rounded-lg p-3 border flex items-center gap-3 transition-colors text-left"
                >
                  <span class="text-2xl">{{ agent.emoji }}</span>
                  <div class="flex-1">
                    <div class="font-medium">{{ agent.name }}</div>
                    <div class="text-xs text-gray-500">{{ agent.description || agent.id }}</div>
                  </div>
                  <i class="bi bi-chevron-right text-gray-500"></i>
                </button>
              </div>
            </div>
            
            <!-- Channels ÂàóË°® -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Channels</h3>
              <div class="space-y-2">
                <button 
                  v-for="(info, name) in manageChannels" 
                  :key="name"
                  @click="showChannelDetail(name, info)"
                  class="w-full bg-[#1f1f1f] hover:bg-[#252525] rounded-lg p-3 border flex items-center gap-3 transition-colors text-left"
                >
                  <div class="w-10 h-10 bg-[#059669] rounded-lg flex items-center justify-center text-xl">üì±</div>
                  <div class="flex-1">
                    <div class="font-medium capitalize">{{ name }}</div>
                    <div class="text-xs text-gray-500">{{ info.accountCount || 0 }} accounts</div>
                  </div>
                  <span 
                    class="text-xs px-2 py-1 rounded"
                    :class="info.enabled ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                  >
                    {{ info.enabled ? 'Enabled' : 'Disabled' }}
                  </span>
                  <i class="bi bi-chevron-right text-gray-500"></i>
                </button>
              </div>
            </div>
            
            <!-- Gateway ÈÖçÁΩÆ -->
            <div>
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Gateway</h3>
              <div class="bg-[#1f1f1f] rounded-lg p-3 border text-sm">
                <div class="flex justify-between py-1">
                  <span class="text-gray-400">HTTP Port</span>
                  <span>{{ gatewayInfo.port }}</span>
                </div>
                <div class="flex justify-between py-1">
                  <span class="text-gray-400">Config Path</span>
                  <span class="text-gray-500 truncate ml-2">~/.openclaw/openclaw.json</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ë©≥ÊÉÖË¶ñÂúñ -->
          <div v-else>
            <!-- ËøîÂõûÊåâÈàï -->
            <button 
              @click="detailView = null"
              class="mb-4 flex items-center gap-2 text-gray-400 hover:text-white transition-colors"
            >
              <i class="bi bi-arrow-left"></i>
              <span>ËøîÂõûÂàóË°®</span>
            </button>
            
            <!-- Agent Ë©≥ÊÉÖ -->
            <div v-if="detailView.type === 'agent'" class="space-y-4">
              <div class="bg-[#1f1f1f] rounded-lg p-6 border text-center">
                <div class="text-6xl mb-4">{{ detailView.data.emoji }}</div>
                <h2 class="text-2xl font-bold">{{ detailView.data.name }}</h2>
                <p class="text-gray-500 mt-2">{{ detailView.data.id }}</p>
              </div>
              
              <div class="bg-[#1f1f1f] rounded-lg p-4 border">
                <h3 class="text-xs text-gray-500 uppercase mb-3">ÈÖçÁΩÆ</h3>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-400">ID</span>
                    <span>{{ detailView.detail?.id }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-400">Workspace</span>
                    <span class="text-gray-500 text-xs">{{ detailView.detail?.workspace?.split('/').pop() }}</span>
                  </div>
                  <div v-if="detailView.detail?.model?.primary" class="flex justify-between">
                    <span class="text-gray-400">Model</span>
                    <span class="text-xs">{{ detailView.detail.model.primary }}</span>
                  </div>
                </div>
              </div>
              
              <div v-if="detailView.detail?.docs && Object.keys(detailView.detail.docs).length > 0" class="space-y-2">
                <h3 class="text-xs text-gray-500 uppercase">ÊñáÊ™î</h3>
                <div v-for="(content, docName) in detailView.detail.docs" :key="docName" class="border rounded-lg overflow-hidden">
                  <button @click="toggleDoc(docName)" class="w-full p-2 text-left flex items-center justify-between bg-[#1f1f1f] hover:bg-[#252525]">
                    <span>{{ docName }}</span>
                    <i class="bi" :class="expandedDocs[docName] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                  </button>
                  <div v-if="expandedDocs[docName]" class="p-2 text-xs text-gray-400 max-h-40 overflow-y-auto whitespace-pre-wrap">
                    {{ content }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Channel Ë©≥ÊÉÖ -->
            <div v-else-if="detailView.type === 'channel'" class="space-y-4">
              <div class="bg-[#1f1f1f] rounded-lg p-6 border text-center">
                <div class="text-6xl mb-4">üì±</div>
                <h2 class="text-2xl font-bold capitalize">{{ detailView.name }}</h2>
                <p class="text-gray-500 mt-2">{{ detailView.data.accountCount }} accounts</p>
              </div>
              <div class="bg-[#1f1f1f] rounded-lg p-4 border">
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full" :class="detailView.data.enabled ? 'bg-green-500' : 'bg-red-500'"></span>
                  <span>{{ detailView.data.enabled ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Â∞çË©±ÂçÄÂüü -->
        <div v-if="currentView === 'chat'" class="flex-1 flex flex-col overflow-hidden">
          <!-- Ë®äÊÅØÂàóË°® -->
          <div ref="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Ê≠°ËøéË®äÊÅØ -->
          <div v-if="messages.length === 0" class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="text-6xl mb-4">{{ selectedAgent.identity.emoji }}</div>
              <h2 class="text-2xl font-bold mb-2">Âó®ÔºåÊàëÊòØ {{ selectedAgent.identity.name }}</h2>
              <p class="text-gray-500">{{ selectedAgent.identity.theme }}</p>
            </div>
          </div>
          
          <!-- Ë®äÊÅØ -->
          <div 
            v-for="(msg, idx) in messages" 
            :key="idx"
            class="message-enter-active flex gap-3"
            :class="{'flex-row-reverse': msg.role === 'user'}"
          >
            <!-- È†≠ÂÉè -->
            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xl"
                 :class="msg.role === 'user' ? 'bg-[#2a2a2a]' : 'bg-[#1f1f1f]'">
              {{ msg.role === 'user' ? 'üë§' : selectedAgent.identity.emoji }}
            </div>
            
            <!-- Ë®äÊÅØÂÖßÂÆπ -->
            <div class="max-w-[70%] rounded-lg"
                 :class="msg.role === 'user' ? 'bg-[#2563eb] text-white' : 'bg-[#1f1f1f]'">
              <!-- Ë®äÊÅØ header: ÊôÇÈñì + Ë§áË£ΩÊåâÈàï -->
              <div class="flex items-center justify-between gap-2 px-3 pt-2 pb-1 border-b border-white/10">
                <span class="text-[10px] opacity-50">{{ formatTime(msg.timestamp) }}</span>
                <button 
                  @click="copyMessage(msg.content)"
                  class="text-xs opacity-50 hover:opacity-100 transition-opacity"
                  title="Ë§áË£ΩË®äÊÅØ"
                >
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div class="p-3">
                <!-- ÂúñÁâáÈ†êË¶Ω -->
                <div v-if="msg.images && msg.images.length > 0" class="mb-2 flex gap-1 flex-wrap">
                  <img 
                    v-for="(img, imgIdx) in msg.images" 
                    :key="imgIdx"
                    :src="img" 
                    class="max-w-32 max-h-32 rounded border border-white/20"
                  >
                </div>
                <!-- ÊñáÂ≠óÂÖßÂÆπ (Markdown Ê∏≤Êüì for AI) -->
                <div v-if="msg.role === 'assistant'" class="markdown-body" v-html="renderContent(msg.content)"></div>
                <div v-else class="whitespace-pre-wrap">{{ typeof msg.content === 'string' ? msg.content : (msg.content.find?.(c => c.type === 'text')?.text || '') }}</div>
                <div v-if="msg.error" class="mt-2 text-red-400 text-sm">
                  <i class="bi bi-exclamation-triangle"></i> {{ msg.error }}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ëº∏ÂÖ•‰∏≠ -->
          <div v-if="isLoading" class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-[#1f1f1f] flex items-center justify-center text-xl">
              {{ selectedAgent.identity.emoji }}
            </div>
            <div class="bg-[#1f1f1f] rounded-lg px-4 py-3">
              <div class="flex gap-1">
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ëº∏ÂÖ•ÂçÄ -->
        <div class="p-4 border-t">
          <!-- ÂúñÁâáÈ†êË¶Ω -->
          <div v-if="uploadedImages.length > 0" class="mb-2 flex gap-2 flex-wrap">
            <div v-for="(img, idx) in uploadedImages" :key="idx" class="relative">
              <img :src="img.preview" class="w-16 h-16 object-cover rounded-lg border">
              <button 
                @click="removeImage(idx)"
                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"
              >
                √ó
              </button>
            </div>
          </div>
          
          <form @submit.prevent="sendMessage" class="flex gap-2">
            <!-- ÂúñÁâá‰∏äÂÇ≥ÊåâÈàï -->
            <label 
              class="bg-[#1f1f1f] hover:bg-[#252525] border rounded-lg px-3 py-2 cursor-pointer transition-colors"
              :class="{'opacity-50 cursor-not-allowed': isLoading}"
            >
              <input 
                type="file" 
                accept="image/*"
                multiple
                @change="handleImageUpload"
                :disabled="isLoading"
                class="hidden"
              >
              <i class="bi bi-image text-xl"></i>
            </label>
            
            <input 
              v-model="inputText"
              :disabled="isLoading"
              type="text" 
              placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..."
              class="flex-1 bg-[#1f1f1f] rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#2563eb] transition-colors"
              @keydown.enter.exact.prevent="sendMessage"
            >
            <button 
              type="submit"
              :disabled="isLoading || (!inputText.trim() && uploadedImages.length === 0)"
              class="bg-[#2563eb] hover:bg-[#1d4ed8] disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg px-4 py-2 transition-colors"
            >
              <i class="bi bi-send"></i>
            </button>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

    createApp({
      setup() {
        // API ÈÖçÁΩÆ - ‰ΩøÁî®Êú¨Âú∞‰ª£ÁêÜ
        const API_BASE = '';
        const API_KEY = ''; // Gateway token
        
        // Agent ÂàóË°®
        const agents = ref([
          { id: 'main', name: 'Kai', identity: { emoji: '‚ö°', name: 'Kai', theme: 'Reliable, Sharp, Proactive, Efficient.' }},
          { id: 'rich', name: 'Rich', identity: { emoji: 'üí∞', name: 'Rich', theme: 'Professional, Analytical, Prudent, Strategic.' }},
          { id: 'code', name: 'code', identity: { emoji: 'üíª', name: 'Code', theme: 'Technical, Precise, Efficient, Problem-solving.' }},
          { id: 'skill-manager', name: 'Skill Manager', identity: { emoji: 'üõ°Ô∏è', name: 'ÊäÄËÉΩÁÆ°ÂÆ∂', theme: 'Professional, Helpful, Systematic, Security-focused.' }},
          { id: 'nexchip', name: 'nexchip', identity: { emoji: 'üî¨', name: 'nexchip', theme: 'Expert in Semiconductor Manufacturing & AI Agent Development' }},
          { id: 'chef', name: 'ÂªöÂ∏´Â∞èÂπ´Êâã', identity: { emoji: 'üç≥', name: 'ÂªöÂ∏´Â∞èÂπ´Êâã', theme: 'Á¥∞ÂøÉ„ÄÅÁÜ±ÊÉÖ„ÄÅÊúâÊ¢ùÁêÜÁöÑÂªöÊàøÂä©Êâã' }},
          { id: 'travel', name: 'travel', identity: { emoji: '‚úàÔ∏è', name: 'ÊóÖË°åÂ∞èÂπ´Êâã', theme: 'ÁÜ±ÊÉÖ„ÄÅÂë®Âà∞„ÄÅÂ∞àÊ•≠ÁöÑÊµ∑Â§ñÊóÖÈÅäÂä©ÊâãÔºåÊìÖÈï∑Ë°åÁ®ãË¶èÂäÉ„ÄÅÁæéÈ£üÊé®Ëñ¶„ÄÅÁøªË≠Ø„ÄÅ‰ΩèÂÆøÈ†êË®Ç„ÄÅ‰∫§ÈÄöÂÆâÊéí' }},
          { id: 'ip', name: 'Â∞àÂà©ÂØ©Êü•', identity: { emoji: 'üìã', name: 'Â∞àÂà©ÂØ©Êü•', theme: 'Â∞àÊ•≠„ÄÅÂö¥Ë¨πÂãôÂØ¶„ÄÅÂª∫Ë®≠ÊÄßÊâπË©ï' }},
          { id: 'startup', name: 'startup', identity: { emoji: 'üöÄ', name: 'ÂâµÊ•≠Â∞èÂπ´Êâã', theme: 'Á©çÊ•µ„ÄÅ‰∏ªÂãï„ÄÅÂãôÂØ¶„ÄÅÂØåÂâµÊÑèÔºåÊìÖÈï∑ÂïÜÊ•≠Á≠ñÁï•„ÄÅË°åÈä∑Êé®Âª£„ÄÅÁî¢ÂìÅÈñãÁôº„ÄÅÁáüÈÅãÁÆ°ÁêÜ„ÄÅË≤°ÂãôË¶èÂäÉ„ÄÅÂúòÈöäÁµÑÂª∫' }}
        ]);
        
        // Ê®°ÂûãÂàóË°®
        const models = ref([
          { id: 'minimax-portal/MiniMax-M2.1', name: 'MiniMax M2.1' },
          { id: 'minimax-portal/MiniMax-M2.1-lightning', name: 'MiniMax M2.1 Lightning' },
          { id: 'zai/glm-4.7', name: 'GLM-4.7' },
          { id: 'zai/glm-5', name: 'GLM-5' },
          { id: 'google/gemini-3-flash-preview', name: 'Gemini Flash (Ë¶ñË¶∫)' }
        ]);
        
        // ÁãÄÊÖã
        const selectedAgent = ref(agents.value[0]);
        const selectedModel = ref(models.value[0].id);
        const messages = ref([]);
        const inputText = ref('');
        const isLoading = ref(false);
        const showAgentDropdown = ref(false);
        
        // Session ÊéßÂà∂ - Âæû localStorage ËºâÂÖ•
        const STORAGE_KEY = 'clawchat_sessions';
        const loadSessions = () => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              return data.sessions || [];
            }
          } catch (e) {}
          return [];
        };
        const loadCurrentSession = () => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              return data.currentSession || null;
            }
          } catch (e) {}
          return null;
        };
        
        // Ê†πÊìö session ID ÊâæÂà∞Â∞çÊáâÁöÑ agent
        const loadSessionAgent = (sessionId) => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              const session = data.sessions?.find(s => s.id === sessionId);
              return session?.agentId || null;
            }
          } catch (e) {}
          return null;
        };
        
        // ÂàùÂßãÂåñ sessions
        const initSessions = () => {
          let loaded = loadSessions();
          let current = loadCurrentSession();
          
          if (!loaded.length) {
            const firstId = `session_${Date.now()}`;
            loaded = [{ id: firstId, name: 'Êñ∞Â∞çË©±', preview: '', agentId: agents.value[0].id }];
            current = firstId;
          }
          
          sessions.value = loaded;
          currentSession.value = current || loaded[0].id;
          
          // ËºâÂÖ• session Â∞çÊáâÁöÑ agent
          const sessionAgentId = loadSessionAgent(currentSession.value);
          if (sessionAgentId) {
            const agent = agents.value.find(a => a.id === sessionAgentId);
            if (agent) selectedAgent.value = agent;
          }
        };
        
        const saveSessions = () => {
          // Êõ¥Êñ∞Áï∂Ââç session ÁöÑ agent ID
          const currentS = sessions.value.find(s => s.id === currentSession.value);
          if (currentS) currentS.agentId = selectedAgent.value.id;
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            sessions: sessions.value,
            currentSession: currentSession.value,
            selectedAgentId: selectedAgent.value.id
          }));
        };
        
        const currentSession = ref(null);
        const sessions = ref([]);
        const showSessionDropdown = ref(false);
        const uploadedImages = ref([]);  // ‰∏äÂÇ≥ÁöÑÂúñÁâá
        const messagesContainer = ref(null);
        const currentView = ref('chat');  // 'chat' or 'manage'
        
        // ÁÆ°ÁêÜÈ†ÅÈù¢Ë≥áÊñô
        const systemStatus = ref('loading');
        const gatewayInfo = ref({ port: 18789 });
        const ngrokUrl = ref(null);
        const manageAgents = ref([]);
        const manageChannels = ref({});
        const detailView = ref(null);  // Ë©≥ÊÉÖË¶ñÂúñ
        const expandedDocs = ref({});   // Â±ïÈñãÁöÑÊñáÊ™î
        
        // Ê™îÊ°àÁÄèË¶ΩÂô®
        const showFileBrowser = ref(false);
        const fileBrowserLoading = ref(false);
        const fileBrowserFiles = ref([]);
        const fileBrowserPath = ref([]);
        const filePreviewContent = ref(null);
        const filePreviewPath = ref('');
        const filePreviewImage = ref(null);
        
        // ‰∏ªÈ°åÊ®°Âºè
        const isDarkMode = ref(true);
        
        // ÂàáÊèõ‰∏ªÈ°å
        const toggleTheme = () => {
          isDarkMode.value = !isDarkMode.value;
          localStorage.setItem('clawchat_theme', isDarkMode.value ? 'dark' : 'light');
          
          // Áõ¥Êé•Êìç‰Ωú DOM ‰æÜÁ¢∫‰øùÊ®£ÂºèÁîüÊïà
          const app = document.getElementById('app');
          if (app) {
            if (isDarkMode.value) {
              app.classList.remove('light-theme');
              app.style.cssText = '';
            } else {
              app.classList.add('light-theme');
              app.style.setProperty('--bg-primary', '#ffffff');
              app.style.setProperty('--bg-secondary', '#f9fafb');
              app.style.setProperty('--bg-hover', '#f3f4f6');
              app.style.setProperty('--border-color', '#e5e7eb');
              app.style.setProperty('--text-primary', '#111827');
              app.style.setProperty('--text-secondary', '#374151');
              app.style.setProperty('--text-muted', '#6b7280');
            }
          }
        };
        
        // ËºâÂÖ•‰∏ªÈ°å
        const loadTheme = () => {
          const saved = localStorage.getItem('clawchat_theme');
          if (saved) {
            isDarkMode.value = saved === 'dark';
          }
          
          // Á¢∫‰øù DOM Ê®£ÂºèÂêåÊ≠•
          if (!isDarkMode.value) {
            setTimeout(() => {
              const app = document.getElementById('app');
              if (app) {
                app.classList.add('light-theme');
                app.style.setProperty('--bg-primary', '#ffffff');
                app.style.setProperty('--bg-secondary', '#f9fafb');
                app.style.setProperty('--bg-hover', '#f3f4f6');
                app.style.setProperty('--border-color', '#e5e7eb');
                app.style.setProperty('--text-primary', '#111827');
                app.style.setProperty('--text-secondary', '#374151');
                app.style.setProperty('--text-muted', '#6b7280');
              }
            }, 100);
          }
        };
        
        // Ê†ºÂºèÂåñÊ™îÊ°àÂ§ßÂ∞è
        const formatFileSize = (bytes) => {
          if (!bytes) return '';
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        };
        
        // Ê†ºÂºèÂåñÊôÇÈñì
        const formatTime = (timestamp) => {
          if (!timestamp) return '';
          const date = new Date(timestamp);
          const now = new Date();
          const isToday = date.toDateString() === now.toDateString();
          
          const time = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
          
          if (isToday) {
            return time;
          }
          return `${date.getMonth() + 1}/${date.getDate()} ${time}`;
        };
        
        // Ë§áË£ΩË®äÊÅØ
        const copyMessage = async (content) => {
          try {
            const text = typeof content === 'string' ? content : (content.find?.(c => c.type === 'text')?.text || '');
            await navigator.clipboard.writeText(text);
            // ÂèØÈÅ∏ÔºöÈ°ØÁ§∫Ë§áË£ΩÊàêÂäüÊèêÁ§∫
          } catch (e) {
            console.error('Failed to copy:', e);
          }
        };
        
        // Ê∏≤ÊüìÂÖßÂÆπ (Markdown for AI)
        const renderContent = (content) => {
          if (!content) return '';
          const text = typeof content === 'string' ? content : (content.find?.(c => c.type === 'text')?.text || '');
          try {
            return marked.parse(text);
          } catch (e) {
            return text;
          }
        };
        
        // ÂàáÊèõÊ™îÊ°àÁÄèË¶ΩÂô®
        const toggleFileBrowser = async () => {
          showFileBrowser.value = !showFileBrowser.value;
          if (showFileBrowser.value && fileBrowserFiles.value.length === 0) {
            await fileBrowserNavigate('');
          }
        };
        
        // ÁÄèË¶ΩÁõÆÈåÑ
        const fileBrowserNavigate = async (path) => {
          fileBrowserLoading.value = true;
          fileBrowserPath.value = path ? path.split('/') : [];
          
          try {
            const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(path)}`;
            const res = await fetch(url);
            const data = await res.json();
            fileBrowserFiles.value = data.files || [];
          } catch (e) {
            console.error('Failed to load files:', e);
            fileBrowserFiles.value = [];
          } finally {
            fileBrowserLoading.value = false;
          }
        };
        
        // ÈñãÂïüÊ™îÊ°à
        const openFile = async (file) => {
          try {
            const fullPath = fileBrowserPath.value.length > 0 
              ? fileBrowserPath.value.join('/') + '/' + file.path 
              : file.path;
            
            // Â¶ÇÊûúÊòØÂúñÁâáÔºåÁõ¥Êé•È°ØÁ§∫ÂúñÁâáÈ†êË¶Ω
            if (isImageFile(file.name)) {
              const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(fullPath)}`;
              const res = await fetch(url);
              const data = await res.json();
              
              if (data.error) {
                alert(data.error);
                return;
              }
              
              // ÂúñÁâáÈúÄË¶ÅÁâπÊÆäËôïÁêÜÔºöÁõ¥Êé•È°ØÁ§∫ÂúñÁâá
              filePreviewPath.value = data.path;
              filePreviewImage.value = data.content; // ÈÄôÊòØ base64 Á∑®Á¢ºÁöÑÂúñÁâá
              filePreviewContent.value = 'IMAGE_PLACEHOLDER'; // Ê®ôË®òÁÇ∫ÂúñÁâá
              return;
            }
            
            // ‰∏ÄËà¨Ê™îÊ°à
            const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(fullPath)}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.error) {
              alert(data.error);
              return;
            }
            
            filePreviewPath.value = data.path;
            filePreviewContent.value = data.content;
            filePreviewImage.value = null; // Ê∏ÖÁ©∫ÂúñÁâá
          } catch (e) {
            console.error('Failed to open file:', e);
            alert('ÁÑ°Ê≥ïÈñãÂïüÊ™îÊ°à');
          }
        };
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂúñÁâáÊ™îÊ°à
        const isImageFile = (filename) => {
          if (!filename) return false;
          const ext = filename.toLowerCase().split('.').pop();
          return ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext);
        };
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ Markdown Ê™îÊ°à
        const isMarkdownFile = (filename) => {
          if (!filename) return false;
          const ext = filename.toLowerCase().split('.').pop();
          return ['md', 'markdown', 'mdown', 'mkd'].includes(ext);
        };
        
        // Ê∏≤Êüì Markdown
        const renderMarkdown = (content) => {
          if (!content) return '';
          try {
            return marked.parse(content);
          } catch (e) {
            return content;
          }
        };
        
        // ÂàáÊèõÊñáÊ™îÂ±ïÈñãÁãÄÊÖã
        const toggleDoc = (docName) => {
          expandedDocs.value[docName] = !expandedDocs.value[docName];
        };
        
        // È°ØÁ§∫ Agent Ë©≥ÊÉÖ
        const showAgentDetail = async (agent) => {
          // ÂèñÂæóË©≥Á¥∞Ë≥áÊñô
          try {
            const res = await fetch(`/api/agent/${agent.id}`);
            const data = await res.json();
            detailView.value = { type: 'agent', data: agent, detail: data };
          } catch (e) {
            console.error(e);
            detailView.value = { type: 'agent', data: agent, detail: null };
          }
        };
        
        // È°ØÁ§∫ Channel Ë©≥ÊÉÖ
        const showChannelDetail = (name, info) => {
          detailView.value = { type: 'channel', name: name, data: info };
        };
        
        // ÂèñÂæóÁÆ°ÁêÜË≥áÊñô
        const fetchManageData = async () => {
          try {
            const [statusRes, agentsRes, channelsRes] = await Promise.all([
              fetch('/api/status'),
              fetch('/api/agents'),
              fetch('/api/channels')
            ]);
            
            const statusData = await statusRes.json();
            const agentsData = await agentsRes.json();
            const channelsData = await channelsRes.json();
            
            systemStatus.value = statusData.status || 'unknown';
            gatewayInfo.value = statusData.gateway || {};
            ngrokUrl.value = statusData.ngrokUrl || null;
            manageAgents.value = agentsData.agents || [];
            manageChannels.value = channelsData.channels || {};
          } catch (e) {
            console.error('Failed to fetch manage data:', e);
            systemStatus.value = 'error';
          }
        };
        
        // ÂïüÂãï ngrok
        const startNgrok = async () => {
          try {
            await fetch('/api/ngrok/start');
            // Á≠âÂæÖ‰∏Ä‰∏ãÂÜçÂà∑Êñ∞ÁãÄÊÖã
            setTimeout(() => fetchManageData(), 3000);
          } catch (e) {
            console.error('Failed to start ngrok:', e);
          }
        };
        
        // ÈÅ∏Êìá Agent
        const selectAgent = (agent) => {
          selectedAgent.value = agent;
          showAgentDropdown.value = false;
        };
        
        // ËôïÁêÜÂúñÁâá‰∏äÂÇ≥
        const handleImageUpload = (event) => {
          const files = event.target.files;
          if (!files) return;
          
          for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              uploadedImages.value.push({
                name: file.name,
                type: file.type,
                dataUrl: e.target.result,  // base64 data URL
                preview: e.target.result   // È†êË¶ΩÁî®
              });
            };
            reader.readAsDataURL(file);
          }
          
          // Ê∏ÖÁ©∫ inputÔºåÂÖÅË®±ÈáçË§áÈÅ∏ÊìáÂêå‰∏ÄÊ™îÊ°à
          event.target.value = '';
        };
        
        // ÁßªÈô§ÂúñÁâá
        const removeImage = (index) => {
          uploadedImages.value.splice(index, 1);
        };
        
        // ÊªæÂãïÂà∞Â∫ïÈÉ®
        const scrollToBottom = () => {
          nextTick(() => {
            if (messagesContainer.value) {
              messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
            }
          });
        };
        
        // ÁôºÈÄÅË®äÊÅØ
        const sendMessage = async () => {
          const text = inputText.value.trim();
          if ((!text && uploadedImages.value.length === 0) || isLoading.value) return;
          
          // ËôïÁêÜÁâπÊÆäÊåá‰ª§
          if (text === '/reset') {
            // Âª∫Á´ãÊñ∞ÁöÑ sessionÔºàÊîπËÆä user IDÔºâ
            currentSession.value = `session_${Date.now()}`;
            messages.value = [];
            inputText.value = '';
            
            // Âª∫Á´ãÊñ∞ session Ë®òÈåÑ
            const newSession = { id: currentSession.value, name: 'Êñ∞Â∞çË©±', preview: '', agentId: selectedAgent.value.id };
            sessions.value.unshift(newSession);
            saveSessions();
            return;
          }
          
          // ÊßãÂª∫Ë®äÊÅØÂÖßÂÆπÔºàÊñáÂ≠ó + ÂúñÁâáÔºâ
          let messageContent;
          if (uploadedImages.value.length > 0) {
            // ÊúâÂúñÁâáÔºö‰ΩøÁî®Èô£ÂàóÊ†ºÂºè
            const contentParts = [];
            if (text) {
              contentParts.push({ type: 'text', text: text });
            }
            for (const img of uploadedImages.value) {
              contentParts.push({
                type: 'image_url',
                image_url: { url: img.dataUrl }
              });
            }
            messageContent = contentParts;
          } else {
            messageContent = text;
          }
          
          // Ê∑ªÂä†Áî®Êà∂Ë®äÊÅØÔºàÂåÖÂê´ÂúñÁâáÈ†êË¶ΩÔºâ
          const userMsg = { role: 'user', content: messageContent, timestamp: Date.now() };
          if (uploadedImages.value.length > 0) {
            userMsg.images = uploadedImages.value.map(img => img.preview);  // ÂÑ≤Â≠òÈ†êË¶Ω
          }
          messages.value.push(userMsg);
          
          inputText.value = '';
          uploadedImages.value = [];  // Ê∏ÖÁ©∫‰∏äÂÇ≥ÁöÑÂúñÁâá
          isLoading.value = true;
          scrollToBottom();
          
          try {
            // Âè™ÂèëÈÄÅÂΩìÂâçÁî®Êà∑Ê∂àÊÅØÔºåËÆ© Gateway Á´ØÁÆ°ÁêÜ‰ºöËØùÂéÜÂè≤
            // ÊûÑÂª∫ÂΩìÂâçÁî®Êà∑Ê∂àÊÅØ
            let userMessageContent = messageContent;
            const apiMessages = [];
            
            // Â§ÑÁêÜÂΩìÂâçÁî®Êà∑Ê∂àÊÅØÔºàÊîØÊåÅÂõæÁâáÔºâ
            if (uploadedImages.value.length > 0) {
              const parts = [];
              if (messageContent) {
                parts.push({ type: 'text', text: messageContent });
              }
              for (const img of uploadedImages.value) {
                parts.push({ type: 'image_url', image_url: { url: img.preview } });
              }
              apiMessages.push({ role: 'user', content: parts });
            } else {
              apiMessages.push({ role: 'user', content: messageContent });
            }
            
            console.log('Sending messages:', JSON.stringify(apiMessages, null, 2));
            
            // ‰ΩøÁî® user ÂèÇÊï∞ËÆ© Gateway ÁÆ°ÁêÜ‰ºöËØùÂéÜÂè≤
            const response = await fetch(`/api/chat`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: `openclaw:${selectedAgent.value.id}`,
                messages: apiMessages,
                stream: true,
                user: `${selectedAgent.value.id}_${currentSession.value}`
              })
            });
            
            console.log('Chat response status:', response.status);
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }
            
            // Âª∫Á´ãÁ©∫ÁöÑ assistant Ë®äÊÅØ
            const assistantMsg = { role: 'assistant', content: '', timestamp: Date.now() };
            messages.value.push(assistantMsg);
            
            // ËôïÁêÜ SSE ÊµÅ
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';
              
              let receivedDone = false;
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') {
                    receivedDone = true;
                    continue;
                  }
                  
                  try {
                    const chunk = JSON.parse(data);
                    const delta = chunk.choices?.[0]?.delta?.content || '';
                    if (delta) {
                      assistantMsg.content += delta;
                      // Âº∑Âà∂Ëß∏Áôº Vue reactivity
                      messages.value = [...messages.value];
                      scrollToBottom();
                    }
                  } catch (e) {}
                }
              }
              if (receivedDone) break;
            }
            
            isLoading.value = false;
          } catch (error) {
            console.error('Error:', error);
            messages.value.push({ 
              role: 'assistant', 
              content: 'Êä±Ê≠âÔºåÁôºÁîüÈåØË™§Ôºö' + error.message,
              error: error.message,
              timestamp: Date.now()
            });
          } finally {
            scrollToBottom();
            // ÂÑ≤Â≠òË®äÊÅØÊ≠∑Âè≤
            saveSessionMessages(currentSession.value, selectedAgent.value.id, messages.value);
          }
        };
        
        // ÂèñÂæó session ÁöÑË®äÊÅØÊ≠∑Âè≤
        const getSessionMessages = (sessionId, agentId) => {
          try {
            const key = `clawchat_${agentId}_${sessionId}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
          } catch (e) {
            return [];
          }
        };
        
        // ÂÑ≤Â≠ò session ÁöÑË®äÊÅØÊ≠∑Âè≤
        const saveSessionMessages = (sessionId, agentId, msgs) => {
          try {
            const key = `clawchat_${agentId}_${sessionId}`;
            localStorage.setItem(key, JSON.stringify(msgs));
          } catch (e) {}
        };
        
        // Ê∏ÖÁ©∫Â∞çË©±
        const clearChat = () => {
          saveSessionMessages(currentSession.value, selectedAgent.value.id, messages.value);
          messages.value = [];
        };
        
        // Session ÂêçÁ®±
        const currentSessionName = computed(() => {
          const s = sessions.value.find(s => s.id === currentSession.value);
          return s ? s.name : 'Êñ∞Â∞çË©±';
        });
        
        // ÂâµÂª∫Êñ∞Â∞çË©±
        const createNewSession = () => {
          // ÂÖàÂÑ≤Â≠òÁï∂Ââç session ÁöÑË®äÊÅØ
          const currentMsgs = messages.value;
          if (currentMsgs.length > 0) {
            const lastUserMsg = [...currentMsgs].reverse().find(m => m.role === 'user');
            const preview = lastUserMsg ? lastUserMsg.content.substring(0, 30) : '...';
            const currentS = sessions.value.find(s => s.id === currentSession.value);
            if (currentS) currentS.preview = preview;
            saveSessionMessages(currentSession.value, selectedAgent.value.id, currentMsgs);
          }
          
          const newId = `session_${Date.now()}`;
          sessions.value.unshift({ 
            id: newId, 
            name: 'Êñ∞Â∞çË©±', 
            preview: '',
            agentId: selectedAgent.value.id  // Ë®ò‰ΩèÁï∂Ââç agent
          });
          currentSession.value = newId;
          messages.value = [];
          saveSessions();
          showSessionDropdown.value = false;
        };
        
        // ÂàáÊèõÂ∞çË©±
        const switchSession = (session) => {
          // ÂÑ≤Â≠òÁï∂Ââç session ÁöÑË®äÊÅØ
          const currentMsgs = messages.value;
          if (currentMsgs.length > 0) {
            const lastUserMsg = [...currentMsgs].reverse().find(m => m.role === 'user');
            const preview = lastUserMsg ? lastUserMsg.content.substring(0, 30) : '...';
            const currentS = sessions.value.find(s => s.id === currentSession.value);
            if (currentS) currentS.preview = preview;
            saveSessionMessages(currentSession.value, selectedAgent.value.id, currentMsgs);
          }
          
          // ÂàáÊèõÂà∞Ë©≤ session Â∞çÊáâÁöÑ agent
          if (session.agentId) {
            const agent = agents.value.find(a => a.id === session.agentId);
            if (agent) selectedAgent.value = agent;
          }
          
          currentSession.value = session.id;
          // ËºâÂÖ•Ë©≤ session ÁöÑË®äÊÅØÔºà‰ΩøÁî®Ë©≤ session ÁöÑ agentÔºâ
          messages.value = getSessionMessages(session.id, session.agentId || selectedAgent.value.id);
          saveSessions();
          showSessionDropdown.value = false;
        };
        
        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ dropdown
        onMounted(() => {
          // ËºâÂÖ•‰∏ªÈ°å
          loadTheme();
          
          // Á¢∫‰øù session Â∑≤ÂàùÂßãÂåñ
          if (!currentSession.value && sessions.value.length > 0) {
            currentSession.value = sessions.value[0].id;
          }
          
          // ËºâÂÖ•Áï∂Ââç session ÁöÑË®äÊÅØ
          if (currentSession.value) {
            messages.value = getSessionMessages(currentSession.value, selectedAgent.value.id);
          }
          
          document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
              showAgentDropdown.value = false;
              showSessionDropdown.value = false;
            }
          });
        });
        
        // ÂàáÊèõ Agent ÊôÇÈ°ØÁ§∫Ê≠°ËøéË®äÊÅØ
        watch(selectedAgent, async () => {
          // ÂÑ≤Â≠ò session ÁöÑ agent ËÆäÊõ¥
          saveSessions();
          
          // Â¶ÇÊûúÊ™îÊ°àÁÄèË¶ΩÂô®ÈñãÂïü‰∏≠ÔºåÈáçÊñ∞ËºâÂÖ•Ê™îÊ°à
          if (showFileBrowser.value) {
            await fileBrowserNavigate('');
          }
          
          if (messages.value.length === 0) {
            // È°ØÁ§∫Ê≠°ËøéË®äÊÅØÂú® messages Èô£Âàó‰∏≠
          }
        });
        
        // ÂàáÊèõÂà∞ÁÆ°ÁêÜÈ†ÅÈù¢ÊôÇÂèñÂæóË≥áÊñô
        watch(currentView, (newView) => {
          if (newView === 'manage') {
            fetchManageData();
          }
        });
        
        return {
          agents,
          models,
          selectedAgent,
          selectedModel,
          messages,
          inputText,
          isLoading,
          showAgentDropdown,
          showSessionDropdown,
          uploadedImages,
          currentSession,
          sessions,
          currentSessionName,
          messagesContainer,
          currentView,
          systemStatus,
          gatewayInfo,
          ngrokUrl,
          manageAgents,
          manageChannels,
          detailView,
          expandedDocs,
          toggleDoc,
          showFileBrowser,
          fileBrowserLoading,
          fileBrowserFiles,
          fileBrowserPath,
          filePreviewContent,
          filePreviewPath,
          filePreviewImage,
          isMarkdownFile,
          isImageFile,
          renderMarkdown,
          formatFileSize,
          toggleFileBrowser,
          fileBrowserNavigate,
          openFile,
          isDarkMode,
          toggleTheme,
          startNgrok,
          showAgentDetail,
          showChannelDetail,
          selectAgent,
          sendMessage,
          clearChat,
          createNewSession,
          switchSession,
          handleImageUpload,
          removeImage,
          formatTime,
          copyMessage,
          renderContent
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
