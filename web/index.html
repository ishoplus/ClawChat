<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawChat - OpenClaw Â∞çË©±‰ªãÈù¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    * { box-sizing: border-box; }
    html, body, #app { height: 100%; margin: 0; padding: 0; }
    body { background: #0f0f0f; color: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    
    /* Message animations */
    .message-enter-active { animation: slideIn 0.3s ease-out; }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Typing indicator */
    .typing-dot { animation: bounce 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    
    /* Agent selector dropdown */
    :root {
      --bg-primary: #161616;
      --bg-secondary: #1f1f1f;
      --bg-hover: #252525;
      --border-color: #333;
      --text-primary: #fff;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
    }
    
    .light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-hover: #f3f4f6;
      --border-color: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #374151;
      --text-muted: #6b7280;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
    }
    
    /* ÊâãÊ©üÁâàÂ∫ïÈÉ®Â∞éËà™ */
    @media (max-width: 1023px) {
      /* Á¢∫‰øù‰∏ªÂÖßÂÆπÂçÄÂüüÊ≠£Á¢∫Â°´ÊªøÂèØÁî®Á©∫Èñì */
      main {
        height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden;
      }
      /* Â∞çË©±ÂçÄÂüü - ÁÑ°Â∫ïÈÉ®Â∞éËà™ */
      .chat-area {
        overflow-y: auto;
        height: 100%;
      }
      /* ÂÖ∂‰ªñË¶ñÂúñÂÖßÂÆπ - ÊúâÂ∫ïÈÉ®Â∞éËà™ */
      .view-content {
        padding-bottom: 70px !important;
        overflow-y: auto;
        height: 100%;
      }
    }
    
    #app {
      background-color: var(--bg-primary, #161616);
      min-height: 100vh;
    }
    
    #app aside {
      background-color: var(--bg-primary, #161616) !important;
      border-color: var(--border-color, #333) !important;
    }
    
    #app main {
      background-color: var(--bg-primary, #161616);
    }
    
    /* Dark/Light backgrounds */
    #app .bg-\[#161616\] { background-color: var(--bg-primary) !important; }
    #app .bg-\[#1f1f1f\] { background-color: var(--bg-secondary) !important; }
    #app .bg-\[#252525\] { background-color: var(--bg-hover) !important; }
    #app .bg-\[#2a2a2a\] { background-color: var(--bg-hover) !important; }
    #app .border-\[#333\] { border-color: var(--border-color) !important; }
    
    /* Text colors */
    #app .text-gray-400 { color: var(--text-secondary) !important; }
    #app .text-gray-500 { color: var(--text-muted) !important; }
    #app .text-gray-300 { color: var(--text-secondary) !important; }
    #app .text-gray-600 { color: var(--text-secondary) !important; }
    #app .text-white { color: var(--text-primary) !important; }
    #app .text-gray-700 { color: var(--text-primary) !important; }
    #app .hover\:text-white:hover { color: var(--text-primary) !important; }
    
    /* Hover states */
    #app .hover\:bg-\[#252525\]\:hover:hover { background-color: var(--bg-hover) !important; }
    #app .hover\:bg-\[#2a2a2a\]\:hover:hover { background-color: var(--bg-hover) !important; }
    #app .bg-gray-200 { background-color: var(--bg-secondary) !important; }
    #app .hover\:bg-gray-300\:hover:hover { background-color: var(--bg-hover) !important; }
    
    /* Input fields */
    #app input, #app textarea { 
      background-color: var(--bg-secondary) !important; 
      color: var(--text-primary) !important; 
      border-color: var(--border-color) !important; 
    }
    #app input::placeholder, #app textarea::placeholder { 
      color: var(--text-muted) !important; 
    }
    
    /* Buttons */
    #app button {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    /* Agent dropdown */
    #app .agent-dropdown {
      background-color: var(--bg-secondary) !important;
    }
    
    /* Dropdown menu styling */
    #app .absolute.top-full {
      background-color: var(--bg-secondary) !important;
    }
    
    #app .absolute.top-full button {
      padding: 12px !important; /* p-3 */
    }
    
    #app .absolute.top-full .p-2 {
      padding: 12px !important;
    }
    
    /* Modal/Preview */
    #app .fixed .bg-\[\#1f1f1f\] {
      background-color: var(--bg-secondary) !important;
    }
    
    /* Cards */
    #app .rounded-lg {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
    }
    
    /* Board message styling - Âç°ÁâáÂºè‰ΩàÂ±Ä */
    #app .board-message,
    .board-message {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #app .board-message:hover,
    .board-message:hover {
      background: var(--bg-hover);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    #app .board-message .meta,
    .board-message .meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }
    #app .board-message .author-row,
    .board-message .author-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #app .board-message .time,
    .board-message .time {
      color: #888;
      font-size: 11px;
    }
    #app .board-message .author,
    .board-message .author {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }
    #app .board-message .author .emoji,
    .board-message .author .emoji {
      font-size: 16px;
    }
    #app .board-message .content,
    .board-message .content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      padding-top: 8px;
      border-top: 1px solid var(--border-color);
    }
    #app .board-message .content ul,
    #app .board-message .content ol,
    .board-message .content ul,
    .board-message .content ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    #app .board-message .content li,
    .board-message .content li {
      margin: 4px 0;
    }
    #app .board-message .content p,
    .board-message .content p {
      margin: 6px 0;
    }
    #app .board-message .content p:first-child,
    .board-message .content p:first-child {
      margin-top: 0;
    }
    #app .board-message .content p:last-child,
    .board-message .content p:last-child {
      margin-bottom: 0;
    }
    
    .agent-dropdown { max-height: 300px; overflow-y: auto; }
    
    /* Markdown preview styles */
    .markdown-body { line-height: 1.6; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--text-primary); margin: 1em 0 0.5em; font-weight: bold; }
    .markdown-body h1 { font-size: 1.5em; }
    .markdown-body h2 { font-size: 1.3em; }
    .markdown-body h3 { font-size: 1.1em; }
    .markdown-body p { margin: 0.5em 0; }
    .markdown-body p:last-child { margin-bottom: 0; }
    .markdown-body code { background: var(--bg-hover); padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; }
    .markdown-body pre { background: var(--bg-hover); padding: 1em; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
    .markdown-body pre code { background: none; padding: 0; }
    .markdown-body ul, .markdown-body ol { padding-left: 1.5em; margin: 0.5em 0; }
    .markdown-body li { margin: 1em 0; line-height: 1.7; padding-left: 0.5em; }
    .markdown-body li > ul, .markdown-body li > ol { margin: 0.5em 0; }
    .markdown-body li p { margin: 0.5em 0; }
    .markdown-body li:first-child { margin-top: 0; }
    .markdown-body li:last-child { margin-bottom: 0; }
    .markdown-body blockquote { padding-left: 1em; color: var(--text-muted); margin: 0.5em 0; }
    .markdown-body a { color: var(--accent); text-decoration: underline; }
    .markdown-body a:hover { color: var(--accent-hover); }
    .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
    .markdown-body th, .markdown-body td { padding: 0.5em; text-align: left; }
    .markdown-body th { background: var(--bg-hover); }
    .markdown-body hr { border: none; margin: 1em 0; }
    .markdown-body img { max-width: 100%; border-radius: 6px; margin: 0.5em 0; }
    .markdown-body strong { color: var(--text-primary); font-weight: bold; }
    .markdown-body em { font-style: italic; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Toast ÈÄöÁü• -->
    <div class="fixed top-4 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2">
      <div 
        v-for="toast in toasts" 
        :key="toast.id"
        class="px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 text-lg font-medium animate-slide-in"
        :class="toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'"
      >
        <i class="bi" :class="toast.type === 'error' ? 'bi-exclamation-circle' : 'bi-check-circle'"></i>
        <span>{{ toast.message }}</span>
      </div>
    </div>

    <div class="flex h-full">
      
      <!-- Â∑¶ÂÅ¥ÈÇäÊ¨ÑÔºöSession ÂàóË°® -->
      <aside class="w-64 bg-[#161616] flex flex-col hidden md:flex border-r border-[#333]">
        <!-- Ê®ôÈ°å -->
        <div class="p-4 border-b border-[#333] flex items-center justify-between">
          <h2 class="font-bold">Â∞çË©±</h2>
          <button 
            @click="showNewChatModal = true"
            class="p-2 rounded-lg hover:bg-[#252525] transition-colors"
            title="Êñ∞Â∞çË©±"
          >
            <i class="bi bi-plus-circle text-xl text-blue-500"></i>
          </button>
        </div>
        
        <!-- Session ÂàóË°® -->
        <div class="flex-1 overflow-y-auto p-2">
          <button 
            v-for="session in sessions" 
            :key="session.id"
            @click="switchSession(session); currentView = 'chat'"
            class="w-full p-3 rounded-lg flex items-center gap-3 mb-1 transition-colors text-left"
            :class="session.id === currentSession ? 'bg-[#2563eb] text-white' : 'hover:bg-[#252525]'"
          >
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0"
              :class="session.id === currentSession ? 'bg-white/20' : 'bg-[#333]'"
            >
              <span v-if="session.source === 'telegram'">üì±</span>
              <span v-else-if="session.source === 'discord'">üí¨</span>
              <span v-else-if="session.source === 'webchat'">üåê</span>
              <span v-else-if="session.source === 'cron'">‚è∞</span>
              <span v-else>üí¨</span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="font-medium truncate">{{ session.name }}</div>
              <div class="text-xs truncate opacity-70">
                <span v-if="agents.find(a => a.id === session.agentId)">{{ agents.find(a => a.id === session.agentId).identity.emoji }} {{ agents.find(a => a.id === session.agentId).identity.name }}</span>
                <span v-else>{{ session.preview || 'Â∞öÁÑ°Ë®äÊÅØ' }}</span>
              </div>
              <div class="text-[10px] text-gray-600 truncate">{{ session.id }}</div>
            </div>
          </button>
          
          <!-- ÁÑ°Â∞çË©±ÊôÇ -->
          <div v-if="sessions.length === 0" class="text-center py-8 text-gray-500">
            <p class="text-sm">Â∞öÁÑ°Â∞çË©±</p>
          </div>
        </div>
        
        <!-- Â∫ïÈÉ®Â∞éËà™ -->
        <div class="p-2 border-t border-[#333] flex justify-around">
          <button 
            @click="currentView = 'board'"
            class="p-2 rounded-lg transition-colors"
            :class="currentView === 'board' ? 'bg-[#2563eb] text-white' : 'text-gray-400 hover:bg-[#252525]'"
            title="ÁïôË®ÄÊùø"
          >
            <i class="bi bi-chat-square-text"></i>
          </button>
          <button 
            @click="currentView = 'schedule'"
            class="p-2 rounded-lg transition-colors"
            :class="currentView === 'schedule' ? 'bg-[#2563eb] text-white' : 'text-gray-400 hover:bg-[#252525]'"
            title="ÊéíÁ®ã"
          >
            <i class="bi bi-clock"></i>
          </button>
          <button 
            @click="currentView = 'manage'"
            class="p-2 rounded-lg transition-colors"
            :class="currentView === 'manage' ? 'bg-[#2563eb] text-white' : 'text-gray-400 hover:bg-[#252525]'"
            title="ÁÆ°ÁêÜ"
          >
            <i class="bi bi-gear"></i>
          </button>
          <button 
            @click="toggleTheme"
            class="p-2 rounded-lg transition-colors"
            :class="isDarkMode ? 'text-yellow-400 hover:bg-[#252525]' : 'text-gray-700 hover:bg-gray-200'"
            :title="isDarkMode ? 'Ê∑∫Ëâ≤Ê®°Âºè' : 'Ê∑±Ëâ≤Ê®°Âºè'"
          >
            <i class="bi" :class="isDarkMode ? 'bi-sun' : 'bi-moon'"></i>
          </button>
        </div>
      </aside>

      <!-- Âè≥ÂÅ¥ÈÇäÊ¨ÑÔºöÊ™îÊ°àÁÄèË¶ΩÂô® -->
      <aside class="w-64 bg-[#161616] flex flex-col hidden lg:flex border-l border-[#333]">
        <!-- Ê™îÊ°àÁÄèË¶ΩÂô® (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 flex-1 overflow-hidden flex flex-col">
          <button 
            @click="toggleFileBrowser"
            class="w-full flex items-center justify-between text-xs text-gray-500 uppercase tracking-wider mb-2 p-3 bg-[#1f1f1f] rounded-lg"
          >
            <span><i class="bi bi-folder me-1"></i> Workspace Ê™îÊ°à</span>
            <i class="bi" :class="showFileBrowser ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>
          
          <!-- Ê™îÊ°àÂàóË°® -->
          <div v-if="showFileBrowser" class="flex-1 overflow-y-auto space-y-1">
            <!-- ËºâÂÖ•‰∏≠ -->
            <div v-if="fileBrowserLoading" class="text-center text-gray-500 text-sm py-4">
              <i class="bi bi-hourglass-split animate-spin"></i> ËºâÂÖ•‰∏≠...
            </div>
            
            <!-- È∫µÂåÖÂ±ëÂ∞éËà™ -->
            <div v-if="fileBrowserPath.length > 0" class="flex items-center gap-1 mb-2 overflow-x-auto">
              <button @click="fileBrowserNavigate('')" class="text-xs text-blue-400 hover:text-blue-300 whitespace-nowrap">
                <i class="bi bi-house"></i> Ê†πÁõÆÈåÑ
              </button>
              <span v-for="(p, idx) in fileBrowserPath" :key="idx" class="flex items-center gap-1">
                <span class="text-gray-600">/</span>
                <button @click="fileBrowserNavigate(fileBrowserPath.slice(0, idx + 1).join('/'))" class="text-xs text-blue-400 hover:text-blue-300 whitespace-nowrap">
                  {{ p }}
                </button>
              </span>
            </div>
            
            <!-- Ê™îÊ°à/Ë≥áÊñôÂ§æÂàóË°® -->
            <div v-if="!fileBrowserLoading && fileBrowserFiles.length === 0" class="text-center text-gray-500 text-xs py-2">
              Ê≤íÊúâÊ™îÊ°à
            </div>
            <button
              v-for="file in fileBrowserFiles"
              :key="file.path"
              @click="file.type === 'directory' ? fileBrowserNavigate(fileBrowserPath.length > 0 ? fileBrowserPath.join('/') + '/' + file.path : file.path) : openFile(file)"
              class="w-full p-2 text-left flex items-center gap-2 hover:bg-[#2a2a2a] rounded text-sm transition-colors"
            >
              <i class="bi" :class="file.type === 'directory' ? 'bi-folder' : 'bi-file-text'"></i>
              <span class="truncate">{{ file.name }}</span>
              <span v-if="file.type === 'file'" class="text-xs text-gray-600 ml-auto">
                {{ formatFileSize(file.size) }}
              </span>
            </button>
          </div>
          
          <!-- Ê™îÊ°àÈ†êË¶ΩÂΩàÁ™ó -->
          <div v-if="filePreviewContent !== null" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" @click.self="filePreviewContent = null">
            <div class="bg-[#1f1f1f] rounded-lg w-full max-w-3xl max-h-[80vh] flex flex-col border">
              <div class="p-3 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i class="bi bi-file-text"></i>
                  <span class="font-medium">{{ filePreviewPath }}</span>
                </div>
                <div class="flex items-center gap-2">
                  <button 
                    @click="copyFileContent"
                    class="text-gray-400 hover:text-white p-1"
                    title="Ë§áË£ΩÂÖßÂÆπ"
                  >
                    <i class="bi bi-clipboard"></i>
                  </button>
                  <button @click="filePreviewContent = null" class="text-gray-400 hover:text-white">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>
              <div class="flex-1 overflow-auto p-3">
                <!-- ÂúñÁâáÈ†êË¶Ω -->
                <div v-if="filePreviewImage" class="flex justify-center">
                  <img :src="filePreviewImage" class="max-w-full max-h-[70vh] object-contain rounded-lg" />
                </div>
                <!-- Markdown È†êË¶Ω -->
                <div v-else-if="isMarkdownFile(filePreviewPath)" class="markdown-body text-sm text-gray-300" v-html="renderMarkdown(filePreviewContent)"></div>
                <!-- Á¥îÊñáÂ≠óÈ†êË¶Ω -->
                <pre v-else class="text-xs text-gray-300 whitespace-pre-wrap">{{ filePreviewContent }}</pre>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Âø´Êç∑Êìç‰Ωú (ÂÉÖÂú®Â∞çË©±Ê®°Âºè‰∏ãÈ°ØÁ§∫) -->
        <div v-if="currentView === 'chat'" class="p-4 mt-auto">
          <button 
            @click="clearChat"
            class="w-full p-2 text-gray-400 hover:text-white hover:bg-[#2a2a2a] rounded-lg flex items-center justify-center gap-2 transition-colors"
          >
            <i class="bi bi-trash"></i>
            <span>Ê∏ÖÁ©∫Â∞çË©±</span>
          </button>
        </div>
      </aside>

      <!-- ‰∏ªÂçÄÂüü -->
      <main class="flex-1 flex flex-col">
        <!-- È†ÇÈÉ®Â∑•ÂÖ∑Ê¨ÑÔºöAgent + Session + Model ÈÅ∏ÊìáÂô® -->
        <div class="p-3 border-b border-[#333] flex items-center gap-3">
          <!-- ÊâãÊ©üÁâàÈÄÄÂá∫ÊåâÈàï -->
          <button 
            v-if="currentView === 'chat'" 
            @click="currentView = 'chats'"
            class="lg:hidden p-2 hover:bg-[#252525] rounded-lg transition-colors"
            title="ËøîÂõû"
          >
            <i class="bi bi-arrow-left text-lg"></i>
          </button>
          
          <!-- Áï∂Ââç Agent È°ØÁ§∫ (ÂîØËÆÄ) -->
          <div v-if="currentView === 'chat'" class="flex items-center gap-2 bg-[#1f1f1f] rounded-lg px-3 py-2">
            <span class="text-lg">{{ selectedAgent.identity.emoji }}</span>
            <span class="text-sm font-medium">{{ selectedAgent.identity.name }}</span>
          </div>
          
          <!-- Ë¶ñÂúñÊ®ôÈ°å (ÈùûÂ∞çË©±Ê®°Âºè) -->
          <div v-if="currentView !== 'chat'" class="flex items-center gap-2">
            <i class="bi text-lg" :class="{
              'bi-gear': currentView === 'manage',
              'bi-chat-square-text': currentView === 'board',
              'bi-clock': currentView === 'schedule',
              'bi-kanban': currentView === 'backlog'
            }"></i>
            <span class="text-sm font-medium">{{ {
              'manage': 'Á≥ªÁµ±ÁÆ°ÁêÜ',
              'board': 'ÁïôË®ÄÁâà',
              'schedule': 'ÊéíÁ®ãÁÆ°ÁêÜ',
              'backlog': 'Backlog ÁúãÊùø'
            }[currentView] }}</span>
          </div>
          
          <!-- Ê®°ÂûãÈÅ∏Êìá (ÂÉÖÂ∞çË©±Ê®°Âºè) -->
          <div class="relative ml-auto" v-if="currentView === 'chat'">
            <button 
              @click="showModelDropdown = !showModelDropdown"
              class="bg-[#1f1f1f] hover:bg-[#252525] rounded-lg px-3 py-2 flex items-center gap-2 transition-colors"
            >
              <i class="bi bi-cpu text-gray-400"></i>
              <span class="text-sm">{{ selectedModelName }}</span>
              <i class="bi bi-chevron-down text-gray-500 text-xs"></i>
            </button>
            
            <!-- Model Dropdown -->
            <div v-if="showModelDropdown" class="absolute top-full right-0 mt-1 bg-[#1f1f1f] rounded-lg shadow-xl z-50">
              <button
                v-for="model in models"
                :key="model.id"
                @click="selectedModel = model.id; showModelDropdown = false"
                class="w-full px-4 py-2 flex items-center gap-3 hover:bg-[#2a2a2a] transition-colors"
                :class="{'bg-[#252525]': model.id === selectedModel}"
              >
                <div class="text-left text-sm">
                  <div class="font-medium">{{ model.name }}</div>
                </div>
                <i v-if="model.id === selectedModel" class="bi bi-check text-green-500 ml-2"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- ÁÆ°ÁêÜÈ†ÅÈù¢ÂÖßÂÆπ (‰∏ªÂçÄÂüü) -->
        <div v-if="currentView === 'manage'" class="view-content flex-1 overflow-y-auto p-4">
          <!-- ÂàóË°®Ë¶ñÂúñ -->
          <div v-if="!detailView">
            <!-- ÁãÄÊÖãÂç°Áâá -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Á≥ªÁµ±ÁãÄÊÖã</h3>
              <div class="bg-[#1f1f1f] rounded-lg p-4 border space-y-3">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full" :class="systemStatus === 'online' ? 'bg-green-500' : 'bg-red-500'"></div>
                  <span class="font-medium">Gateway {{ systemStatus }}</span>
                </div>
                
                <!-- ngrok -->
                <div v-if="ngrokUrl" class="pt-3">
                  <div class="text-xs text-gray-500 mb-2">ÂÖ¨ÈñãÁ∂≤ÂùÄ</div>
                  <a :href="ngrokUrl" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm break-all">
                    {{ ngrokUrl }}
                  </a>
                </div>
                <div v-else class="pt-3">
                  <button 
                    @click="startNgrok"
                    class="w-full py-2 bg-[#2563eb] hover:bg-[#1d4ed8] rounded-lg text-sm transition-colors"
                  >
                    <i class="bi bi-box-arrow-up-right me-1"></i> ÂïüÂãï ngrok
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Agents ÂàóË°® -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Agents ({{ manageAgents.length }})</h3>
              <div class="space-y-2">
                <button 
                  v-for="agent in manageAgents" 
                  :key="agent.id"
                  @click="showAgentDetail(agent)"
                  class="w-full bg-[#1f1f1f] hover:bg-[#252525] rounded-lg p-3 border flex items-center gap-3 transition-colors text-left md:flex-nowrap flex-wrap"
                >
                  <span class="text-2xl flex-shrink-0">{{ agent.emoji }}</span>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium truncate">{{ agent.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ agent.description || agent.id }}</div>
                  </div>
                  <i class="bi bi-chevron-right text-gray-500 flex-shrink-0"></i>
                </button>
              </div>
            </div>
            
            <!-- Sessions ÂàóË°® -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Sessions ({{ manageSessions.length }})</h3>
              <div v-if="manageSessionsLoading" class="text-center py-4 text-gray-500">
                <i class="bi bi-arrow-repeat animate-spin text-xl"></i> ËºâÂÖ•‰∏≠...
              </div>
              <div v-else class="space-y-2 max-h-80 overflow-y-auto">
                <div 
                  v-for="session in manageSessions" 
                  :key="session.id"
                  class="bg-[#1f1f1f] hover:bg-[#252525] rounded-lg p-3 border flex items-center gap-3 transition-colors md:flex-nowrap flex-wrap"
                >
                  <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl flex-shrink-0"
                    :class="{
                      'bg-blue-500/20': session.source === 'telegram',
                      'bg-indigo-500/20': session.source === 'discord', 
                      'bg-green-500/20': session.source === 'webchat',
                      'bg-yellow-500/20': session.source === 'cron',
                      'bg-purple-500/20': session.source === 'main',
                      'bg-gray-500/20': session.source === 'unknown'
                    }"
                  >
                    <span v-if="session.source === 'telegram'">üì±</span>
                    <span v-else-if="session.source === 'discord'">üí¨</span>
                    <span v-else-if="session.source === 'webchat'">üåê</span>
                    <span v-else-if="session.source === 'cron'">‚è∞</span>
                    <span v-else-if="session.source === 'main'">üè†</span>
                    <span v-else>‚ùì</span>
                  </div>
                  <div class="flex-1 min-w-0 w-full md:w-auto">
                    <div class="font-medium truncate">{{ session.id }}</div>
                    <div class="text-xs text-gray-500 truncate">
                      {{ session.agentId }} ¬∑ {{ session.age }} ¬∑ {{ session.model }}
                    </div>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <div class="text-sm font-medium">{{ session.tokens?.toLocaleString() || 0 }}</div>
                    <div class="text-xs text-gray-500">{{ session.contextPercent }}%</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Channels ÂàóË°® -->
            <div class="mb-6">
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Channels</h3>
              <div class="space-y-2">
                <button 
                  v-for="(info, name) in manageChannels" 
                  :key="name"
                  @click="showChannelDetail(name, info)"
                  class="w-full bg-[#1f1f1f] hover:bg-[#252525] rounded-lg p-3 border flex items-center gap-3 transition-colors text-left md:flex-nowrap flex-wrap"
                >
                  <div class="w-10 h-10 bg-[#059669] rounded-lg flex items-center justify-center text-xl flex-shrink-0">üì±</div>
                  <div class="flex-1 min-w-0 w-full md:w-auto">
                    <div class="font-medium capitalize">{{ name }}</div>
                    <div class="text-xs text-gray-500">{{ info.accountCount || 0 }} accounts</div>
                  </div>
                  <span 
                    class="text-xs px-2 py-1 rounded flex-shrink-0"
                    :class="info.enabled ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                  >
                    {{ info.enabled ? 'Enabled' : 'Disabled' }}
                  </span>
                  <i class="bi bi-chevron-right text-gray-500 flex-shrink-0"></i>
                </button>
              </div>
            </div>
            
            <!-- Gateway ÈÖçÁΩÆ -->
            <div>
              <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-3">Gateway</h3>
              <div class="bg-[#1f1f1f] rounded-lg p-3 border text-sm">
                <div class="flex flex-col md:flex-row md:justify-between py-1 gap-1">
                  <span class="text-gray-400">HTTP Port</span>
                  <span>{{ gatewayInfo.port }}</span>
                </div>
                <div class="flex flex-col md:flex-row md:justify-between py-1 gap-1">
                  <span class="text-gray-400">Config Path</span>
                  <span class="text-gray-500 truncate">~/.openclaw/openclaw.json</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ë©≥ÊÉÖË¶ñÂúñ -->
          <div v-else>
            <!-- ËøîÂõûÊåâÈàï -->
            <button 
              @click="detailView = null"
              class="mb-4 flex items-center gap-2 text-gray-400 hover:text-white transition-colors"
            >
              <i class="bi bi-arrow-left"></i>
              <span>ËøîÂõûÂàóË°®</span>
            </button>
            
            <!-- Agent Ë©≥ÊÉÖ -->
            <div v-if="detailView.type === 'agent'" class="space-y-4">
              <div class="bg-[#1f1f1f] rounded-lg p-4 md:p-6 border text-center">
                <div class="text-4xl md:text-6xl mb-4">{{ detailView.data.emoji }}</div>
                <h2 class="text-xl md:text-2xl font-bold">{{ detailView.data.name }}</h2>
                <p class="text-gray-500 mt-2 text-sm truncate">{{ detailView.data.id }}</p>
              </div>
              
              <div class="bg-[#1f1f1f] rounded-lg p-4 border">
                <h3 class="text-xs text-gray-500 uppercase mb-3">ÈÖçÁΩÆ</h3>
                <div class="space-y-2 text-sm">
                  <div class="flex flex-col md:flex-row md:justify-between gap-1">
                    <span class="text-gray-400">ID</span>
                    <span class="truncate">{{ detailView.detail?.id }}</span>
                  </div>
                  <div class="flex flex-col md:flex-row md:justify-between gap-1">
                    <span class="text-gray-400">Workspace</span>
                    <span class="text-gray-500 text-xs truncate">{{ detailView.detail?.workspace?.split('/').pop() }}</span>
                  </div>
                  <div v-if="detailView.detail?.model?.primary" class="flex flex-col md:flex-row md:justify-between gap-1">
                    <span class="text-gray-400">Model</span>
                    <span class="text-xs truncate">{{ detailView.detail.model.primary }}</span>
                  </div>
                </div>
              </div>
              
              <div v-if="detailView.detail?.docs && Object.keys(detailView.detail.docs).length > 0" class="space-y-2">
                <h3 class="text-xs text-gray-500 uppercase">ÊñáÊ™î</h3>
                <div v-for="(content, docName) in detailView.detail.docs" :key="docName" class="border rounded-lg overflow-hidden">
                  <button @click="toggleDoc(docName)" class="w-full p-2 text-left flex items-center justify-between bg-[#1f1f1f] hover:bg-[#252525]">
                    <span>{{ docName }}</span>
                    <i class="bi" :class="expandedDocs[docName] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                  </button>
                  <div v-if="expandedDocs[docName]" class="p-2 text-xs text-gray-400 max-h-40 overflow-y-auto whitespace-pre-wrap">
                    {{ content }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Channel Ë©≥ÊÉÖ -->
            <div v-else-if="detailView.type === 'channel'" class="space-y-4">
              <div class="bg-[#1f1f1f] rounded-lg p-4 md:p-6 border text-center">
                <div class="text-4xl md:text-6xl mb-4">üì±</div>
                <h2 class="text-xl md:text-2xl font-bold capitalize">{{ detailView.name }}</h2>
                <p class="text-gray-500 mt-2">{{ detailView.data.accountCount }} accounts</p>
              </div>
              <div class="bg-[#1f1f1f] rounded-lg p-4 border">
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full flex-shrink-0" :class="detailView.data.enabled ? 'bg-green-500' : 'bg-red-500'"></span>
                  <span>{{ detailView.data.enabled ? 'Â∑≤ÂïüÁî®' : 'Â∑≤ÂÅúÁî®' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ÁïôË®ÄÊùøÂÖßÂÆπ -->
        <div v-if="currentView === 'board'" class="view-content flex-1 overflow-y-auto p-4 md:p-6" :class="isDarkMode ? 'bg-[#0f0f0f]' : 'bg-gray-50'">
          <div class="max-w-4xl mx-auto">
            <!-- È†ÇÈÉ®Ê®ôÈ°åÂàó -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
              <div>
                <h2 class="text-2xl font-bold flex items-center gap-3" :class="isDarkMode ? 'text-white' : 'text-gray-900'">
                  <span class="w-10 h-10 rounded-xl flex items-center justify-center" :class="isDarkMode ? 'bg-[#2563eb]' : 'bg-blue-500'">
                    <i class="bi bi-chat-square-text text-white"></i>
                  </span>
                  ÂÖ¨ÂÖ±ÁïôË®ÄÊùø
                </h2>
                <p v-if="boardLastUpdate" class="text-sm mt-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-clock me-1"></i>ÊúÄÂæåÊõ¥Êñ∞Ôºö{{ boardLastUpdate }}
                </p>
              </div>
              
              <!-- ÊéßÂà∂È†Ö -->
              <div class="flex items-center gap-2">
                <!-- Ëá™ÂãïÂà∑Êñ∞ÈñãÈóú -->
                <button 
                  @click="boardAutoRefresh = !boardAutoRefresh"
                  class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm transition-colors"
                  :class="boardAutoRefresh ? (isDarkMode ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-600') : (isDarkMode ? 'bg-[#1f1f1f] text-gray-400' : 'bg-white text-gray-500')"
                  :title="boardAutoRefresh ? 'Ëá™ÂãïÂà∑Êñ∞Â∑≤ÈñãÂïü (30Áßí)' : 'Ëá™ÂãïÂà∑Êñ∞Â∑≤ÈóúÈñâ'"
                >
                  <i class="bi" :class="boardAutoRefresh ? 'bi-arrow-repeat' : 'bi-arrow-repeat'"></i>
                  <span class="hidden sm:inline">{{ boardAutoRefresh ? 'Ëá™Âãï' : 'ÈóúÈñâ' }}</span>
                </button>
                
                <!-- ÈáçÊñ∞Êï¥ÁêÜÊåâÈàï -->
                <button 
                  @click="loadBoard"
                  :disabled="boardLoading"
                  class="p-2 rounded-lg transition-colors"
                  :class="isDarkMode ? 'bg-[#1f1f1f] hover:bg-[#252525] text-gray-400' : 'bg-white hover:bg-gray-100 text-gray-600'"
                  title="ÈáçÊñ∞Êï¥ÁêÜ"
                >
                  <i class="bi bi-arrow-clockwise" :class="boardLoading ? 'animate-spin' : ''"></i>
                </button>
              </div>
            </div>
            
            <!-- ÂÖßÂÆπÂç°Áâá -->
            <div 
              class="rounded-2xl border overflow-hidden transition-all"
              :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333] shadow-lg shadow-black/20' : 'bg-white border-gray-200 shadow-md'"
            >
              <!-- ËºâÂÖ•‰∏≠ÁãÄÊÖã -->
              <div v-if="boardLoading && !boardContent" class="flex flex-col items-center justify-center py-16">
                <div class="w-12 h-12 rounded-full border-4 border-t-transparent animate-spin mb-4"
                     :class="isDarkMode ? 'border-blue-500 border-t-transparent' : 'border-blue-500 border-t-transparent'">
                </div>
                <p :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">ËºâÂÖ•‰∏≠...</p>
              </div>
              
              <!-- ÁïôË®ÄÂÖßÂÆπ -->
              <div v-else class="p-6">
                <!-- Á©∫ÁãÄÊÖã -->
                <div v-if="!boardContent" class="text-center py-12" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-inbox text-4xl mb-4 block"></i>
                  <p>Â∞öÁÑ°ÁïôË®Ä</p>
                </div>
                
                <!-- ÊúâÂÖßÂÆπ -->
                <div 
                  v-else 
                  class="board-messages markdown-body"
                  :class="isDarkMode ? 'text-gray-300' : 'text-gray-700'"
                  v-html="renderBoardMessages(boardContent)"
                  style="padding: 8px;"
                >
                </div>
              </div>
              
              <!-- Â∫ïÈÉ®ÁãÄÊÖãÂàó -->
              <div 
                v-if="boardContent"
                class="px-6 py-3 border-t flex items-center justify-between text-sm"
                :class="isDarkMode ? 'border-[#333] text-gray-500' : 'border-gray-100 text-gray-400'"
              >
                <span><i class="bi bi-info-circle me-1"></i>ÂîØËÆÄÊ®°Âºè</span>
                <span v-if="boardLoading"><i class="bi bi-arrow-clockwise animate-spin me-1"></i>Êõ¥Êñ∞‰∏≠...</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ÊéíÁ®ãÂÖßÂÆπ - ÂÑ™ÂåñÁâàÈõôÊ¨Ñ‰ΩàÂ±Ä -->
        <div v-if="currentView === 'schedule'" class="view-content flex-1 overflow-y-auto p-4" :class="isDarkMode ? 'bg-[#0f0f0f]' : 'bg-white'">
          <!-- ËºâÂÖ•‰∏≠ -->
          <div v-if="scheduleLoading" class="flex items-center justify-center h-64">
            <div class="text-center" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
              <i class="bi bi-hourglass-split animate-spin text-3xl"></i>
              <p class="mt-2">ËºâÂÖ•‰∏≠...</p>
            </div>
          </div>
          
          <div v-else class="max-w-7xl mx-auto">
            <!-- È†ÇÈÉ®ÁãÄÊÖãÂàó -->
            <div class="rounded-xl p-4 mb-4 border" :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333]' : 'bg-gray-100 border-gray-200'">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <h2 class="text-xl font-bold flex items-center gap-2" :class="isDarkMode ? 'text-white' : 'text-gray-900'">
                  <i class="bi bi-clock"></i>
                  ÊéíÁ®ãÁ∏ΩË¶Ω
                </h2>
                <div class="flex items-center gap-3">
                  <!-- Áµ±Ë®àÊ®ôÁ±§ -->
                  <div class="flex gap-1 rounded-lg p-1" :class="isDarkMode ? 'bg-[#252525]' : 'bg-gray-200'">
                    <span class="px-3 py-1.5 rounded-md text-sm font-medium" :class="isDarkMode ? 'bg-[#333] text-white' : 'bg-white text-gray-900 shadow-sm'">
                      ÂÖ®ÈÉ® ({{ cronJobs.length }})
                    </span>
                    <span class="px-3 py-1.5 rounded-md text-sm font-medium text-green-500">
                      ÂïüÁî® ({{ cronJobs.filter(j => j.enabled).length }})
                    </span>
                    <span class="px-3 py-1.5 rounded-md text-sm font-medium" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">
                      ÂÅúÁî® ({{ cronJobs.filter(j => !j.enabled).length }})
                    </span>
                  </div>
                  <button 
                    @click="loadSchedules"
                    class="p-2 rounded-lg transition-colors"
                    :class="isDarkMode ? 'hover:bg-[#252525] text-gray-400' : 'hover:bg-gray-200 text-gray-600'"
                    title="ÈáçÊñ∞Êï¥ÁêÜ"
                  >
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ÈõôÊ¨Ñ‰ΩàÂ±Ä -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
              <!-- Â∑¶ÂÅ¥ÔºöAgent ÂàóË°® -->
              <div class="lg:col-span-1">
                <div class="rounded-xl p-4 sticky top-4 border" :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333]' : 'bg-gray-50 border-gray-200'">
                  <h3 class="text-lg font-semibold mb-4 flex items-center gap-2" :class="isDarkMode ? 'text-white' : 'text-gray-900'">
                    ü§ñ Agent ÂàóË°®
                  </h3>
                  <div class="space-y-2">
                    <div 
                      v-for="item in schedules" 
                      :key="item.workspace"
                      class="p-3 rounded-lg border transition-colors"
                      :class="item.hasSchedule ? (isDarkMode ? 'border-green-500/30 bg-green-500/5' : 'border-green-500/30 bg-green-50') : (isDarkMode ? 'border-[#333] hover:border-[#444]' : 'border-gray-200 hover:border-gray-300')"
                    >
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                          <span class="text-xl">{{ item.emoji }}</span>
                          <div>
                            <div class="font-medium text-sm" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ item.name }}</div>
                            <div class="text-xs" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">{{ item.workspace }}</div>
                          </div>
                        </div>
                        <span 
                          class="text-xs px-2 py-1 rounded-full"
                          :class="item.hasSchedule ? (isDarkMode ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700') : (isDarkMode ? 'bg-gray-500/20 text-gray-400' : 'bg-gray-200 text-gray-500')"
                        >
                          {{ item.hasSchedule ? '‚úì ' + item.tasks.length : 'ÁÑ°' }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Âè≥ÂÅ¥ÔºöCron Jobs ÂàóË°® -->
              <div class="lg:col-span-3 space-y-3">
                <div v-if="cronJobs.length === 0" class="text-center py-12" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-clock text-4xl mb-4 block"></i>
                  <p>Â∞öÁÑ°ÊéíÁ®ã‰ªªÂãô</p>
                </div>
                
                <!-- Job Âç°Áâá -->
                <div 
                  v-for="job in cronJobs" 
                  :key="job.id"
                  class="rounded-xl border overflow-hidden transition-all"
                  :class="[isDarkMode ? 'bg-[#1f1f1f] border-[#333] hover:border-[#444]' : 'bg-white border-gray-200 hover:border-gray-300', expandedJob === job.id ? 'ring-2 ring-blue-500' : '']"
                >
                  <!-- Âç°Áâá-header (ÂèØÈªûÊìäÂ±ïÈñã) -->
                  <div 
                    class="p-4 cursor-pointer transition-colors"
                    :class="isDarkMode ? 'hover:bg-[#252525]/50' : 'hover:bg-gray-50'"
                    @click="expandedJob = expandedJob === job.id ? null : job.id"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <!-- ÁãÄÊÖãÊåáÁ§∫Ááà -->
                        <div 
                          class="w-3 h-3 rounded-full"
                          :class="job.enabled ? 'bg-green-500 animate-pulse' : (isDarkMode ? 'bg-gray-500' : 'bg-gray-400')"
                        ></div>
                        
                        <!-- ÂúñÊ®ô -->
                        <span class="text-xl" :title="'ÁõÆÊ®ô: ' + (job.sessionTarget || 'ÂÖ®Â±Ä')">
                          {{ getJobIcon(job.sessionTarget) }}
                        </span>
                        
                        <!-- ÂêçÁ®±ËàáÊéíÁ®ã -->
                        <div>
                          <h4 class="font-semibold" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ job.name }}</h4>
                          <p class="text-sm font-mono" :class="isDarkMode ? 'text-gray-500' : 'text-gray-500'">{{ job.schedule }}</p>
                        </div>
                      </div>
                      
                      <div class="flex items-center gap-4">
                        <!-- ‰∏ãÊ¨°Âü∑Ë°å -->
                        <div v-if="job.nextRun" class="hidden sm:block text-right">
                          <p class="text-xs" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">‰∏ãÊ¨°Âü∑Ë°å</p>
                          <p class="text-sm text-green-500">{{ job.nextRun }}</p>
                        </div>
                        
                        <!-- ÁãÄÊÖãÊ®ôÁ±§ -->
                        <span 
                          class="text-xs px-2 py-1 rounded"
                          :class="job.enabled ? (isDarkMode ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700') : (isDarkMode ? 'bg-gray-500/20 text-gray-400' : 'bg-gray-200 text-gray-500')"
                        >
                          {{ job.enabled ? 'ÂïüÁî®' : 'ÂÅúÁî®' }}
                        </span>
                        
                        <!-- Â±ïÈñãÂúñÊ®ô -->
                        <span 
                          class="transition-transform"
                          :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'"
                          :class="expandedJob === job.id ? 'rotate-180' : ''"
                        >
                          ‚ñº
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Â±ïÈñãË©≥ÊÉÖ -->
                  <div v-if="expandedJob === job.id" class="border-t p-4" :class="isDarkMode ? 'border-[#333] bg-[#252525]/30' : 'border-gray-200 bg-gray-50'">
                    <div class="space-y-3">
                      <!-- Ë©≥Á¥∞Ë≥áË®äÁ∂≤Ê†º -->
                      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <div class="rounded-lg p-3" :class="isDarkMode ? 'bg-[#1f1f1f]' : 'bg-white'">
                          <p class="text-xs mb-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">ÁõÆÊ®ô</p>
                          <p class="font-medium" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ job.sessionTarget || 'ÂÖ®Â±Ä' }}</p>
                        </div>
                        <div class="rounded-lg p-3" :class="isDarkMode ? 'bg-[#1f1f1f]' : 'bg-white'">
                          <p class="text-xs mb-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">È°ûÂûã</p>
                          <p class="font-medium" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ job.scheduleKind || 'cron' }}</p>
                        </div>
                        <div class="rounded-lg p-3" :class="isDarkMode ? 'bg-[#1f1f1f]' : 'bg-white'">
                          <p class="text-xs mb-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">‰∏ãÊ¨°Âü∑Ë°å</p>
                          <p class="font-medium text-green-500">{{ job.nextRun || '-' }}</p>
                        </div>
                        <div class="rounded-lg p-3" :class="isDarkMode ? 'bg-[#1f1f1f]' : 'bg-white'">
                          <p class="text-xs mb-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">ÁãÄÊÖã</p>
                          <p :class="job.lastStatus === 'ok' ? 'text-green-500' : (isDarkMode ? 'text-red-400' : 'text-red-600')">
                            {{ job.lastStatus || 'unknown' }}
                          </p>
                        </div>
                      </div>
                      
                      <!-- Âü∑Ë°åË≥áË®ä -->
                      <div class="flex flex-wrap gap-4 text-sm">
                        <div v-if="job.lastRun" class="flex items-center gap-1">
                          <span :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">‰∏äÊ¨°Ôºö</span>
                          <span :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">{{ job.lastRun }}</span>
                        </div>
                        <div v-if="job.lastDuration" class="flex items-center gap-1">
                          <span :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">ËÄóÊôÇÔºö</span>
                          <span class="text-blue-500">{{ job.lastDuration }}</span>
                        </div>
                        <div v-if="job.consecutiveErrors > 0" class="flex items-center gap-1">
                          <span :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">ÈÄ£Á∫åÈåØË™§Ôºö</span>
                          <span class="text-red-500">{{ job.consecutiveErrors }}</span>
                        </div>
                      </div>
                      
                      <!-- ÈåØË™§Ë®äÊÅØ -->
                      <div v-if="job.lastError" class="p-3 rounded-lg border" :class="isDarkMode ? 'bg-red-500/10 border-red-500/30' : 'bg-red-50 border-red-200'">
                        <span class="text-sm" :class="isDarkMode ? 'text-red-400' : 'text-red-600'">ÈåØË™§Ôºö{{ job.lastError }}</span>
                      </div>
                      
                      <!-- Prompt È†êË¶Ω -->
                      <div v-if="job.message || job.messagePreview" class="rounded-lg p-3" :class="isDarkMode ? 'bg-[#1f1f1f]' : 'bg-white'">
                        <p class="text-xs mb-2" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">Prompt</p>
                        <p class="text-sm line-clamp-3 font-mono" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">
                          {{ (job.messagePreview || job.message).substring(0, 300) }}{{ (job.messagePreview || job.message).length > 300 ? '...' : '' }}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ËÅäÂ§©ÂàóË°®ÂÖßÂÆπ -->
        <div v-if="currentView === 'chats'" class="view-content flex-1 overflow-y-auto p-4" :class="isDarkMode ? 'bg-[#0f0f0f]' : 'bg-gray-50'">
          <div class="max-w-2xl mx-auto">
            <!-- È†ÇÈÉ®Ê®ôÈ°å -->
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold" :class="isDarkMode ? 'text-white' : 'text-gray-900'">
                ËÅäÂ§©
              </h2>
              <button @click="showNewChatModal = true" class="p-2 rounded-lg hover:bg-[#252525]">
                <i class="bi bi-plus-circle text-xl text-blue-500"></i>
              </button>
            </div>
            
            <!-- Â∞çË©±ÂàóË°® -->
            <div class="space-y-2">
              <button 
                v-for="session in sessions" 
                :key="session.id"
                @click="switchSession(session); currentView = 'chat'"
                class="w-full p-4 flex items-center gap-3 rounded-xl transition-colors text-left"
                :class="session.id === currentSession ? (isDarkMode ? 'bg-[#252525]' : 'bg-blue-50') : (isDarkMode ? 'bg-[#1f1f1f] hover:bg-[#252525]' : 'bg-white hover:bg-gray-100')"
              >
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl flex-shrink-0"
                  :class="isDarkMode ? 'bg-[#333]' : 'bg-gray-200'"
                >
                  <span v-if="session.source === 'telegram'">üì±</span>
                  <span v-else-if="session.source === 'discord'">üí¨</span>
                  <span v-else-if="session.source === 'webchat'">üåê</span>
                  <span v-else-if="session.source === 'cron'">‚è∞</span>
                  <span v-else>üí¨</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium truncate">{{ session.name }}</div>
                  <div class="text-sm truncate" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                    <span v-if="agents.find(a => a.id === session.agentId)">{{ agents.find(a => a.id === session.agentId).identity.emoji }} {{ agents.find(a => a.id === session.agentId).identity.name }}</span>
                    <span v-else>{{ session.preview || 'Â∞öÁÑ°Ë®äÊÅØ' }}</span>
                  </div>
                  <div class="text-xs text-gray-600 truncate">{{ session.id }}</div>
                </div>
                <div class="text-xs flex-shrink-0" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  {{ session.age }}
                </div>
              </button>
              
              <!-- ÁÑ°Â∞çË©±ÊôÇ -->
              <div v-if="sessions.length === 0" class="text-center py-12 text-gray-500">
                <i class="bi bi-chat-dots text-4xl mb-4"></i>
                <p>Â∞öÁÑ°Â∞çË©±</p>
                <button @click="showNewChatModal = true" class="mt-4 px-4 py-2 bg-[#2563eb] text-white rounded-lg">
                  ÈñãÂßãÊñ∞Â∞çË©±
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Backlog ÁúãÊùøÂÖßÂÆπ -->
        <div v-if="currentView === 'backlog'" class="view-content flex-1 overflow-y-auto p-4" :class="isDarkMode ? 'bg-[#0f0f0f]' : 'bg-white'">
          <!-- È†ÇÈÉ®Ê®ôÈ°åÂàó -->
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold flex items-center gap-3" :class="isDarkMode ? 'text-white' : 'text-gray-900'">
                <span class="w-10 h-10 rounded-xl flex items-center justify-center" :class="isDarkMode ? 'bg-[#8b5cf6]' : 'bg-purple-500'">
                  <i class="bi bi-kanban text-white"></i>
                </span>
                Backlog ÁúãÊùø
              </h2>
              <p v-if="backlogLastUpdate" class="text-sm mt-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                <i class="bi bi-clock me-1"></i>ÊúÄÂæåÊõ¥Êñ∞Ôºö{{ backlogLastUpdate }}
              </p>
            </div>
            
            <!-- ÊéßÂà∂È†Ö -->
            <div class="flex items-center gap-2">
              <button 
                @click="loadBacklog"
                :disabled="backlogLoading"
                class="p-2 rounded-lg transition-colors"
                :class="isDarkMode ? 'bg-[#1f1f1f] hover:bg-[#252525] text-gray-400' : 'bg-white hover:bg-gray-100 text-gray-600'"
                title="ÈáçÊñ∞Êï¥ÁêÜ"
              >
                <i class="bi bi-arrow-clockwise" :class="backlogLoading ? 'animate-spin' : ''"></i>
              </button>
            </div>
          </div>
          
          <!-- ÁúãÊùøÂÖßÂÆπ -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- To Do Ê¨Ñ -->
            <div class="rounded-xl border overflow-hidden" :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333]' : 'bg-white border-gray-200'">
              <div class="px-4 py-3 border-b flex items-center gap-2" :class="isDarkMode ? 'border-[#333] bg-[#252525]' : 'border-gray-100 bg-gray-50'">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                <h3 class="font-semibold" :class="isDarkMode ? 'text-white' : 'text-gray-900'">üîµ To Do</h3>
                <span class="ml-auto text-sm" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">{{ backlogData.todo.length }}</span>
              </div>
              <div class="p-3 space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                <div v-if="backlogLoading && backlogData.todo.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-hourglass-split animate-spin text-2xl"></i>
                  <p class="mt-2 text-sm">ËºâÂÖ•‰∏≠...</p>
                </div>
                <div v-else-if="backlogData.todo.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-inbox text-2xl"></i>
                  <p class="mt-2 text-sm">Ê≤íÊúâÂæÖËæ¶‰∫ãÈ†Ö</p>
                </div>
                <div 
                  v-for="(task, idx) in backlogData.todo" 
                  :key="'todo-'+idx"
                  class="rounded-lg p-3 border transition-all hover:shadow-md cursor-pointer"
                  :class="isDarkMode ? 'border-[#333] hover:border-[#444] bg-[#252525]' : 'border-gray-200 hover:border-gray-300 bg-white'"
                >
                  <div class="font-medium text-sm mb-2" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ task.title }}</div>
                  <div v-if="task.author" class="text-xs" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                    <i class="bi bi-person me-1"></i>{{ task.author }}
                  </div>
                  <div v-if="task.date" class="text-xs mt-1" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                    <i class="bi bi-calendar me-1"></i>{{ task.date }}
                  </div>
                  <div v-if="task.description" class="text-xs mt-2 line-clamp-2" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">
                    {{ task.description }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- In Progress Ê¨Ñ -->
            <div class="rounded-xl border overflow-hidden" :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333]' : 'bg-white border-gray-200'">
              <div class="px-4 py-3 border-b flex items-center gap-2" :class="isDarkMode ? 'border-[#333] bg-[#252525]' : 'border-gray-100 bg-gray-50'">
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                <h3 class="font-semibold" :class="isDarkMode ? 'text-white' : 'text-gray-900'">üü° In Progress</h3>
                <span class="ml-auto text-sm" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">{{ backlogData.inProgress.length }}</span>
              </div>
              <div class="p-3 space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                <div v-if="backlogLoading && backlogData.inProgress.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-hourglass-split animate-spin text-2xl"></i>
                  <p class="mt-2 text-sm">ËºâÂÖ•‰∏≠...</p>
                </div>
                <div v-else-if="backlogData.inProgress.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-inbox text-2xl"></i>
                  <p class="mt-2 text-sm">Ê≤íÊúâÈÄ≤Ë°å‰∏≠ÁöÑ‰ªªÂãô</p>
                </div>
                <div 
                  v-for="(task, idx) in backlogData.inProgress" 
                  :key="'ip-'+idx"
                  class="rounded-lg p-3 border transition-all hover:shadow-md cursor-pointer"
                  :class="isDarkMode ? 'border-yellow-500/30 hover:border-yellow-500/50 bg-[#252525]' : 'border-yellow-300/50 hover:border-yellow-300 bg-white'"
                >
                  <div class="font-medium text-sm mb-2" :class="isDarkMode ? 'text-white' : 'text-gray-900'">{{ task.title }}</div>
                  <div v-if="task.author" class="text-xs" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                    <i class="bi bi-person me-1"></i>{{ task.author }}
                  </div>
                  <div v-if="task.assignee && task.assignee !== 'ÂæÖË™çÈ†ò'" class="text-xs mt-1" :class="isDarkMode ? 'text-yellow-400' : 'text-yellow-600'">
                    <i class="bi bi-person-check me-1"></i>{{ task.assignee }}
                  </div>
                  <div v-if="task.description" class="text-xs mt-2 line-clamp-2" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">
                    {{ task.description }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Done Ê¨Ñ -->
            <div class="rounded-xl border overflow-hidden" :class="isDarkMode ? 'bg-[#1f1f1f] border-[#333]' : 'bg-white border-gray-200'">
              <div class="px-4 py-3 border-b flex items-center gap-2" :class="isDarkMode ? 'border-[#333] bg-[#252525]' : 'border-gray-100 bg-gray-50'">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <h3 class="font-semibold" :class="isDarkMode ? 'text-white' : 'text-gray-900'">‚úÖ Done</h3>
                <span class="ml-auto text-sm" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">{{ backlogData.done.length }}</span>
              </div>
              <div class="p-3 space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                <div v-if="backlogLoading && backlogData.done.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-hourglass-split animate-spin text-2xl"></i>
                  <p class="mt-2 text-sm">ËºâÂÖ•‰∏≠...</p>
                </div>
                <div v-else-if="backlogData.done.length === 0" class="text-center py-8" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                  <i class="bi bi-inbox text-2xl"></i>
                  <p class="mt-2 text-sm">Ê≤íÊúâÂ∑≤ÂÆåÊàêÁöÑ‰ªªÂãô</p>
                </div>
                <div 
                  v-for="(task, idx) in backlogData.done" 
                  :key="'done-'+idx"
                  class="rounded-lg p-3 border transition-all hover:shadow-md cursor-pointer opacity-75"
                  :class="isDarkMode ? 'border-green-500/30 hover:border-green-500/50 bg-[#252525]' : 'border-green-300/50 hover:border-green-300 bg-white'"
                >
                  <div class="font-medium text-sm mb-2 line-through" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">{{ task.title }}</div>
                  <div v-if="task.author" class="text-xs" :class="isDarkMode ? 'text-gray-500' : 'text-gray-400'">
                    <i class="bi bi-person me-1"></i>{{ task.author }}
                  </div>
                  <div v-if="task.assignee && task.assignee !== 'ÂæÖË™çÈ†ò'" class="text-xs mt-1" :class="isDarkMode ? 'text-green-400' : 'text-green-600'">
                    <i class="bi bi-check-circle me-1"></i>{{ task.assignee }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Â∞çË©±ÂçÄÂüü -->
        <div v-if="currentView === 'chat'" class="chat-area flex-1 flex flex-col overflow-hidden">
          <!-- Ë®äÊÅØÂàóË°® -->
          <div ref="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
          <!-- Ê≠°ËøéË®äÊÅØ -->
          <div v-if="messages.length === 0" class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="text-6xl mb-4">{{ selectedAgent.identity.emoji }}</div>
              <h2 class="text-2xl font-bold mb-2">Âó®ÔºåÊàëÊòØ {{ selectedAgent.identity.name }}</h2>
              <p class="text-gray-500">{{ selectedAgent.identity.theme }}</p>
            </div>
          </div>
          
          <!-- Ë®äÊÅØ -->
          <div 
            v-for="(msg, idx) in messages" 
            :key="idx"
            class="message-enter-active flex gap-3"
            :class="{'flex-row-reverse': msg.role === 'user'}"
          >
            <!-- È†≠ÂÉè -->
            <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xl"
                 :class="msg.role === 'user' ? 'bg-[#2a2a2a]' : 'bg-[#1f1f1f]'">
              {{ msg.role === 'user' ? 'üë§' : selectedAgent.identity.emoji }}
            </div>
            
            <!-- Ë®äÊÅØÂÖßÂÆπ -->
            <div class="max-w-[70%] rounded-lg"
                 :class="msg.role === 'user' ? 'bg-[#2563eb] text-white' : (isDarkMode ? 'bg-[#1f1f1f] text-white' : 'bg-[#1f1f1f] text-gray-700')">
              <!-- Ë®äÊÅØ header: ÊôÇÈñì + Ë§áË£ΩÊåâÈàï -->
              <div class="flex items-center justify-between gap-2 px-3 pt-2 pb-1">
                <span class="text-[10px]" :class="isDarkMode ? 'opacity-50' : 'opacity-60'">{{ formatTime(msg.timestamp) }}</span>
                <button 
                  @click="copyMessage(msg.content)"
                  class="text-xs" :class="isDarkMode ? 'opacity-50 hover:opacity-100' : 'opacity-40 hover:opacity-70'"
                  title="Ë§áË£ΩË®äÊÅØ"
                >
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              <div class="p-3">
                <!-- ÂúñÁâáÈ†êË¶Ω -->
                <div v-if="msg.images && msg.images.length > 0" class="mb-2 flex gap-1 flex-wrap">
                  <img 
                    v-for="(img, imgIdx) in msg.images" 
                    :key="imgIdx"
                    :src="img" 
                    class="max-w-32 max-h-32 rounded"
                  >
                </div>
                <!-- ÊñáÂ≠óÂÖßÂÆπ (Markdown Ê∏≤Êüì for AI) -->
                <div v-if="msg.role === 'assistant'" class="markdown-body" v-html="renderContent(msg.content)"></div>
                <div v-else class="whitespace-pre-wrap">{{ typeof msg.content === 'string' ? msg.content : (msg.content.find?.(c => c.type === 'text')?.text || '') }}</div>
                <div v-if="msg.error" class="mt-2 text-red-400 text-sm">
                  <i class="bi bi-exclamation-triangle"></i> {{ msg.error }}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ëº∏ÂÖ•‰∏≠ -->
          <div v-if="isLoading" class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-[#1f1f1f] flex items-center justify-center text-xl">
              {{ selectedAgent.identity.emoji }}
            </div>
            <div class="bg-[#1f1f1f] rounded-lg px-4 py-3">
              <div class="flex gap-1">
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
                <span class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ëº∏ÂÖ•ÂçÄ -->
        <div class="p-4 lg:pb-4 pb-20">
          <!-- ÂúñÁâáÈ†êË¶Ω -->
          <div v-if="uploadedImages.length > 0" class="mb-2 flex gap-2 flex-wrap">
            <div v-for="(img, idx) in uploadedImages" :key="idx" class="relative">
              <img :src="img.preview" class="w-16 h-16 object-cover rounded-lg border">
              <button 
                @click="removeImage(idx)"
                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"
              >
                √ó
              </button>
            </div>
          </div>
          
          <form @submit.prevent="sendMessage" class="flex gap-2">
            <!-- ÂúñÁâá‰∏äÂÇ≥ÊåâÈàï -->
            <label 
              class="bg-[#1f1f1f] hover:bg-[#252525] border rounded-lg px-3 py-2 cursor-pointer transition-colors"
              :class="{'opacity-50 cursor-not-allowed': isLoading}"
            >
              <input 
                type="file" 
                accept="image/*"
                multiple
                @change="handleImageUpload"
                :disabled="isLoading"
                class="hidden"
              >
              <i class="bi bi-image text-xl"></i>
            </label>
            
            <input 
              v-model="inputText"
              :disabled="isLoading"
              type="text" 
              placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..."
              class="flex-1 bg-[#1f1f1f] rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#2563eb] transition-colors"
              @keydown.enter.exact.prevent="sendMessage"
            >
            <button 
              type="submit"
              :disabled="isLoading || (!inputText.trim() && uploadedImages.length === 0)"
              class="bg-[#2563eb] hover:bg-[#1d4ed8] disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg px-4 py-2 transition-colors"
            >
              <i class="bi bi-send"></i>
            </button>
          </form>
        </div>
      </main>
      
      <!-- Êñ∞Âª∫Â∞çË©± Modal -->
      <div v-if="showNewChatModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
          <div class="p-4 border-b border-[#333] flex items-center justify-between">
            <h3 class="font-bold text-lg">Êñ∞Â∞çË©±</h3>
            <button @click="showNewChatModal = false" class="p-2 hover:bg-[#252525] rounded-lg">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="p-4">
            <p class="text-sm text-gray-400 mb-4">ÈÅ∏Êìá‰∏ÄÂÄã Agent ÈñãÂßãÊñ∞Â∞çË©±</p>
            <div class="space-y-2 max-h-[60vh] overflow-y-auto">
              <button
                v-for="agent in agents"
                :key="agent.id"
                @click="createNewSession(agent)"
                class="w-full p-4 rounded-xl flex items-center gap-3 transition-colors text-left"
                :class="isDarkMode ? 'bg-[#252525] hover:bg-[#333]' : 'bg-gray-100 hover:bg-gray-200'"
              >
                <span class="text-2xl">{{ agent.identity.emoji }}</span>
                <div class="flex-1">
                  <div class="font-medium">{{ agent.identity.name }}</div>
                  <div class="text-xs text-gray-500">{{ agent.identity.theme }}</div>
                </div>
                <i class="bi bi-chevron-right text-gray-500"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ÊâãÊ©üÁâàÂ∫ïÈÉ®Â∞éËà™Ê¨Ñ (ÂæÆ‰ø°È¢®Ê†º) -->
      <!-- ÊâãÊ©üÁâàÂ∫ïÈÉ®Â∞éËà™ (ÂÉÖÂú®ÈùûÂ∞çË©±È†ÅÈù¢È°ØÁ§∫) -->
      <nav v-if="currentView !== 'chat'" class="lg:hidden fixed bottom-0 left-0 right-0 z-[100] border-t border-[#333] flex" :class="isDarkMode ? 'bg-[#161616]' : 'bg-white'" style="padding-bottom: env(safe-area-inset-bottom, 0);">
        <button @click="currentView = 'chats'" class="flex-1 py-3 flex flex-col items-center gap-0.5" :class="currentView === 'chats' ? 'text-blue-500' : 'text-gray-500'">
          <i class="bi bi-chat-dots text-xl"></i><span class="text-[10px]">ËÅäÂ§©</span>
        </button>
        <button @click="currentView = 'board'" class="flex-1 py-3 flex flex-col items-center gap-0.5" :class="currentView === 'board' ? 'text-blue-500' : 'text-gray-500'">
          <i class="bi bi-chat-square-text text-xl"></i><span class="text-[10px]">ÁïôË®Ä</span>
        </button>
        <button @click="currentView = 'schedule'" class="flex-1 py-3 flex flex-col items-center gap-0.5" :class="currentView === 'schedule' ? 'text-blue-500' : 'text-gray-500'">
          <i class="bi bi-clock text-xl"></i><span class="text-[10px]">ÊéíÁ®ã</span>
        </button>
        <button @click="currentView = 'manage'" class="flex-1 py-3 flex flex-col items-center gap-0.5" :class="currentView === 'manage' ? 'text-blue-500' : 'text-gray-500'">
          <i class="bi bi-gear text-xl"></i><span class="text-[10px]">ÁÆ°ÁêÜ</span>
        </button>
      </nav>
      
      <!-- ÊâãÊ©üÁâà Session ÈÅ∏Êìá Sheet -->
      <div v-if="showMobileSessionSheet" @click="showMobileSessionSheet = false" class="lg:hidden fixed inset-0 bg-black/50 z-40"></div>
      <div v-if="showMobileSessionSheet" class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-[#1f1f1f] rounded-t-3xl shadow-2xl max-h-[70vh] overflow-hidden">
        <div class="flex justify-center pt-3"><div class="w-10 h-1 bg-gray-600 rounded-full"></div></div>
        <div class="px-4 py-2 flex items-center justify-between border-b border-[#333]">
          <h3 class="text-sm font-medium">ÈÅ∏ÊìáÂ∞çË©±</h3>
          <button @click="showMobileSessionSheet = false" class="p-2 text-gray-400 hover:text-white">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="overflow-y-auto max-h-[60vh]">
          <!-- Êñ∞Âª∫Â∞çË©± -->
          <button @click="showMobileSessionSheet = false; showNewChatModal = true" class="w-full p-4 flex items-center gap-3 hover:bg-[#252525] border-b border-[#333]">
            <div class="w-10 h-10 rounded-full bg-[#2563eb] flex items-center justify-center text-white">
              <i class="bi bi-plus"></i>
            </div>
            <span class="font-medium">Êñ∞Â∞çË©±</span>
          </button>
          <!-- Session ÂàóË°® -->
          <button 
            v-for="session in sessions" 
            :key="session.id"
            @click="switchSession(session); showMobileSessionSheet = false; currentView = 'chat'"
            class="w-full p-4 flex items-center gap-3 hover:bg-[#252525] border-b border-[#333]"
            :class="session.id === currentSession ? 'bg-[#252525]' : ''"
          >
            <div class="w-10 h-10 rounded-full bg-[#333] flex items-center justify-center text-lg">
              <span v-if="session.source === 'telegram'">üì±</span>
              <span v-else-if="session.source === 'discord'">üí¨</span>
              <span v-else-if="session.source === 'webchat'">üåê</span>
              <span v-else-if="session.source === 'cron'">‚è∞</span>
              <span v-else>üí¨</span>
            </div>
            <div class="flex-1 min-w-0 text-left">
              <div class="font-medium truncate">{{ session.name }}</div>
              <div class="text-xs text-gray-500 truncate">
                <span v-if="agents.find(a => a.id === session.agentId)">{{ agents.find(a => a.id === session.agentId).identity.emoji }} {{ agents.find(a => a.id === session.agentId).identity.name }}</span>
                <span v-else>{{ session.preview || 'Â∞öÁÑ°Ë®äÊÅØ' }}</span>
              </div>
              <div class="text-xs text-gray-600 truncate">{{ session.id }}</div>
            </div>
            <i v-if="session.id === currentSession" class="bi bi-check-circle text-blue-500"></i>
          </button>
        </div>
      </div>
      
      <!-- ÊâãÊ©üÁâàÊõ¥Â§öÈÅ∏È†ÖÂΩàÁ™ó -->
      <div v-if="showMobileMenu" @click="showMobileMenu = false" class="lg:hidden fixed inset-0 bg-black/50 z-40"></div>
      <div v-if="showMobileMenu" class="lg:hidden fixed bottom-20 left-4 right-4 z-50 bg-[#1f1f1f] rounded-2xl shadow-2xl overflow-hidden">
        <!-- ÈóúÈñâÊåâÈàï -->
        <button @click="showMobileMenu = false" class="absolute top-2 right-2 p-2 text-gray-400 hover:text-white">
          <i class="bi bi-x-lg"></i>
        </button>
        <!-- ‰∏ªÈ°å -->
        <button @click="toggleTheme(); showMobileMenu = false" class="w-full flex items-center gap-3 p-4 hover:bg-[#252525] border-b border-[#333]">
          <i class="bi text-lg" :class="isDarkMode ? 'bi-sun text-yellow-400' : 'bi-moon text-gray-400'"></i>
          <span class="flex-1 text-left">{{ isDarkMode ? 'Ê∑∫Ëâ≤Ê®°Âºè' : 'Ê∑±Ëâ≤Ê®°Âºè' }}</span>
        </button>
        <!-- Ê∏ÖÁ©∫Â∞çË©± -->
        <button v-if="currentView === 'chat'" @click="clearChat(); showMobileMenu = false" class="w-full flex items-center gap-3 p-4 hover:bg-red-500/10">
          <i class="bi bi-trash text-lg text-red-400"></i>
          <span class="flex-1 text-left text-red-400">Ê∏ÖÁ©∫Â∞çË©±</span>
        </button>
      </div>
      
      <!-- ÊâãÊ©üÁâà Agent ÈÅ∏Êìá Sheet -->
      <div v-if="showMobileAgentSheet" @click="showMobileAgentSheet = false" class="lg:hidden fixed inset-0 bg-black/50 z-50"></div>
      <div v-if="showMobileAgentSheet" class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-[#1f1f1f] rounded-t-3xl shadow-2xl max-h-[70vh] overflow-hidden">
        <div class="flex justify-center pt-3"><div class="w-10 h-1 bg-gray-600 rounded-full"></div></div>
        <div class="px-4 pb-4 overflow-y-auto">
          <h3 class="text-sm text-gray-500 mb-3">ÈÅ∏Êìá Agent</h3>
          <div class="grid grid-cols-2 gap-2">
            <button v-for="agent in agents" :key="agent.id" @click="selectAgent(agent); showMobileAgentSheet = false" class="p-3 flex items-center gap-3 rounded-xl" :class="agent.id === selectedAgent.id ? 'bg-[#2563eb] text-white' : 'bg-[#252525] hover:bg-[#333]'">
              <span class="text-xl">{{ agent.identity.emoji }}</span>
              <span class="text-sm font-medium">{{ agent.identity.name }}</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- ÊâãÊ©üÁâà Model ÈÅ∏Êìá Sheet -->
      <div v-if="showMobileModelSheet" @click="showMobileModelSheet = false" class="lg:hidden fixed inset-0 bg-black/50 z-50"></div>
      <div v-if="showMobileModelSheet" class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-[#1f1f1f] rounded-t-3xl shadow-2xl max-h-[60vh] overflow-hidden">
        <div class="flex justify-center pt-3"><div class="w-10 h-1 bg-gray-600 rounded-full"></div></div>
        <div class="px-4 pb-4 overflow-y-auto">
          <h3 class="text-sm text-gray-500 mb-3">ÈÅ∏ÊìáÊ®°Âûã</h3>
          <div class="space-y-2">
            <button v-for="model in models" :key="model.id" @click="selectedModel = model.id; showMobileModelSheet = false" class="w-full p-3 flex items-center gap-3 rounded-xl" :class="model.id === selectedModel ? 'bg-[#2563eb] text-white' : 'bg-[#252525] hover:bg-[#333]'">
              <span class="text-sm">{{ model.name }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

    createApp({
      setup() {
        // API ÈÖçÁΩÆ - ‰ΩøÁî®Êú¨Âú∞‰ª£ÁêÜÔºàÁî± Next.js ËôïÁêÜÔºâ
        
        // Agent ÂàóË°®
        const agents = ref([
          { id: 'main', name: 'Kai', identity: { emoji: '‚ö°', name: 'Kai', theme: 'Reliable, Sharp, Proactive, Efficient.' }},
          { id: 'rich', name: 'Rich', identity: { emoji: 'üí∞', name: 'Rich', theme: 'Professional, Analytical, Prudent, Strategic.' }},
          { id: 'code', name: 'code', identity: { emoji: 'üíª', name: 'Code', theme: 'Technical, Precise, Efficient, Problem-solving.' }},
          { id: 'skill-manager', name: 'Skill Manager', identity: { emoji: 'üõ°Ô∏è', name: 'ÊäÄËÉΩÁÆ°ÂÆ∂', theme: 'Professional, Helpful, Systematic, Security-focused.' }},
          { id: 'nexchip', name: 'nexchip', identity: { emoji: 'üî¨', name: 'nexchip', theme: 'Expert in Semiconductor Manufacturing & AI Agent Development' }},
          { id: 'chef', name: 'ÂªöÂ∏´Â∞èÂπ´Êâã', identity: { emoji: 'üç≥', name: 'ÂªöÂ∏´Â∞èÂπ´Êâã', theme: 'Á¥∞ÂøÉ„ÄÅÁÜ±ÊÉÖ„ÄÅÊúâÊ¢ùÁêÜÁöÑÂªöÊàøÂä©Êâã' }},
          { id: 'travel', name: 'travel', identity: { emoji: '‚úàÔ∏è', name: 'ÊóÖË°åÂ∞èÂπ´Êâã', theme: 'ÁÜ±ÊÉÖ„ÄÅÂë®Âà∞„ÄÅÂ∞àÊ•≠ÁöÑÊµ∑Â§ñÊóÖÈÅäÂä©ÊâãÔºåÊìÖÈï∑Ë°åÁ®ãË¶èÂäÉ„ÄÅÁæéÈ£üÊé®Ëñ¶„ÄÅÁøªË≠Ø„ÄÅ‰ΩèÂÆøÈ†êË®Ç„ÄÅ‰∫§ÈÄöÂÆâÊéí' }},
          { id: 'ip', name: 'Â∞àÂà©ÂØ©Êü•', identity: { emoji: 'üìã', name: 'Â∞àÂà©ÂØ©Êü•', theme: 'Â∞àÊ•≠„ÄÅÂö¥Ë¨πÂãôÂØ¶„ÄÅÂª∫Ë®≠ÊÄßÊâπË©ï' }},
          { id: 'startup', name: 'startup', identity: { emoji: 'üöÄ', name: 'ÂâµÊ•≠Â∞èÂπ´Êâã', theme: 'Á©çÊ•µ„ÄÅ‰∏ªÂãï„ÄÅÂãôÂØ¶„ÄÅÂØåÂâµÊÑèÔºåÊìÖÈï∑ÂïÜÊ•≠Á≠ñÁï•„ÄÅË°åÈä∑Êé®Âª£„ÄÅÁî¢ÂìÅÈñãÁôº„ÄÅÁáüÈÅãÁÆ°ÁêÜ„ÄÅË≤°ÂãôË¶èÂäÉ„ÄÅÂúòÈöäÁµÑÂª∫' }}
        ]);
        
        // Ê®°ÂûãÂàóË°®
        const models = ref([
          { id: 'minimax-portal/MiniMax-M2.1', name: 'MiniMax M2.1' },
          { id: 'minimax-portal/MiniMax-M2.5', name: 'MiniMax M2.5 (Ë¶ñË¶∫)', supportsVision: true },
          { id: 'minimax-portal/MiniMax-M2.1-lightning', name: 'MiniMax M2.1 Lightning' },
          { id: 'zai/glm-4.7', name: 'GLM-4.7' },
          { id: 'zai/glm-5', name: 'GLM-5' },
          { id: 'google/gemini-3-flash-preview', name: 'Gemini Flash (Ë¶ñË¶∫)', supportsVision: true },
          { id: 'ollama/llava:latest', name: 'LLaVA (Êú¨Âú∞)', supportsVision: true },
          { id: 'ollama/moondream:latest', name: 'Moondream (Êú¨Âú∞)', supportsVision: true },
        ]);
        
        // ÁãÄÊÖã
        const selectedAgent = ref(agents.value[0]);
        const selectedModel = ref(models.value[0].id);
        const messages = ref([]);
        const inputText = ref('');
        const isLoading = ref(false);
        const showAgentDropdown = ref(false);
        const showModelDropdown = ref(false);
        const showMobileMenu = ref(false);
        const showMobileAgentSheet = ref(false);
        const showMobileModelSheet = ref(false);
        const showMobileSessionSheet = ref(false);
        const showMobileFileSheet = ref(false);
        const showNewChatModal = ref(false);
        const toasts = ref([]);
        
        // Toast ÈÄöÁü•
        const showToast = (message, type = 'success') => {
          const id = Date.now();
          toasts.value.push({ id, message, type });
          setTimeout(() => {
            toasts.value = toasts.value.filter(t => t.id !== id);
          }, 3000);
        };
        
        // Session ÊéßÂà∂ - Âæû localStorage ËºâÂÖ•
        const STORAGE_KEY = 'clawchat_sessions';
        const loadSessions = () => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              return data.sessions || [];
            }
          } catch (e) {}
          return [];
        };
        const loadCurrentSession = () => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              return data.currentSession || null;
            }
          } catch (e) {}
          return null;
        };
        
        // Ê†πÊìö session ID ÊâæÂà∞Â∞çÊáâÁöÑ agent
        const loadSessionAgent = (sessionId) => {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              const data = JSON.parse(saved);
              const session = data.sessions?.find(s => s.id === sessionId);
              return session?.agentId || null;
            }
          } catch (e) {}
          return null;
        };
        
        // ÂàùÂßãÂåñ sessions
        const initSessions = () => {
          let loaded = loadSessions();
          let current = loadCurrentSession();
          
          if (!loaded.length) {
            const firstId = `session_${Date.now()}`;
            loaded = [{ id: firstId, name: 'Êñ∞Â∞çË©±', preview: '', agentId: agents.value[0].id }];
            current = firstId;
          }
          
          sessions.value = loaded;
          currentSession.value = current || loaded[0].id;
          
          // ËºâÂÖ• session Â∞çÊáâÁöÑ agent
          const sessionAgentId = loadSessionAgent(currentSession.value);
          if (sessionAgentId) {
            const agent = agents.value.find(a => a.id === sessionAgentId);
            if (agent) selectedAgent.value = agent;
          }
        };
        
        const saveSessions = () => {
          // Êõ¥Êñ∞Áï∂Ââç session ÁöÑ agent ID
          const currentS = sessions.value.find(s => s.id === currentSession.value);
          if (currentS) currentS.agentId = selectedAgent.value.id;
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify({
            sessions: sessions.value,
            currentSession: currentSession.value,
            selectedAgentId: selectedAgent.value.id
          }));
        };
        
        const currentSession = ref(null);
        const sessions = ref([]);
        const showSessionDropdown = ref(false);
        const uploadedImages = ref([]);  // ‰∏äÂÇ≥ÁöÑÂúñÁâá
        const messagesContainer = ref(null);
        const currentView = ref('chat');  // 'chat' or 'manage' or 'board'
        
        // ÁïôË®ÄÊùøË≥áÊñô
        const boardContent = ref('');
        const boardLoading = ref(false);
        const boardAutoRefresh = ref(true);     // Ëá™ÂãïÂà∑Êñ∞
        const boardLastUpdate = ref('');         // ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
        let boardAutoRefreshTimer = null;       // Ëá™ÂãïÂà∑Êñ∞Ë®àÊôÇÂô®
        
        // Backlog ÁúãÊùøË≥áÊñô
        const backlogContent = ref('');
        const backlogLoading = ref(false);
        const backlogLastUpdate = ref('');      // ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
        let backlogAutoRefreshTimer = null;     // Ëá™ÂãïÂà∑Êñ∞Ë®àÊôÇÂô®
        
        // ÊéíÁ®ãË≥áÊñô
        const schedules = ref([]);
        const scheduleLoading = ref(false);
        const expandedJob = ref(null);  // Â±ïÈñãÁöÑ job Ë©≥ÊÉÖ
        
        // Áç≤Âèñ job ÂúñÊ®ô
        const getJobIcon = (target) => {
          if (!target || target === 'isolated') return 'üîß';
          if (target === 'code') return 'üíª';
          if (target === 'rich') return 'üí∞';
          if (target === 'skill-manager') return 'üõ°Ô∏è';
          if (target === 'startup') return 'üöÄ';
          if (target === 'travel') return '‚úàÔ∏è';
          if (target === 'chef') return 'üç≥';
          if (target === 'ip') return 'üìã';
          if (target === 'nexchip') return 'üî¨';
          if (target === 'shared') return 'üìã';
          if (target === 'main') return '‚ö°Ô∏è';
          return 'ü§ñ';
        };
        
        // ËºâÂÖ•ÁïôË®ÄÊùø
        
        // ÁÆ°ÁêÜÈ†ÅÈù¢Ë≥áÊñô
        const systemStatus = ref('loading');
        const gatewayInfo = ref({ port: 18789 });
        const ngrokUrl = ref(null);
        const manageAgents = ref([]);
        const manageChannels = ref({});
        const manageSessions = ref([]);
        const manageSessionsLoading = ref(false);
        const detailView = ref(null);  // Ë©≥ÊÉÖË¶ñÂúñ
        const expandedDocs = ref({});   // Â±ïÈñãÁöÑÊñáÊ™î
        
        // Ê™îÊ°àÁÄèË¶ΩÂô®
        const showFileBrowser = ref(false);
        const fileBrowserLoading = ref(false);
        const fileBrowserFiles = ref([]);
        const fileBrowserPath = ref([]);
        const filePreviewContent = ref(null);
        const filePreviewPath = ref('');
        const filePreviewImage = ref(null);
        
        // ‰∏ªÈ°åÊ®°Âºè
        const isDarkMode = ref(true);
        
        // ÂàáÊèõ‰∏ªÈ°å
        const toggleTheme = () => {
          isDarkMode.value = !isDarkMode.value;
          localStorage.setItem('clawchat_theme', isDarkMode.value ? 'dark' : 'light');
          
          // Áõ¥Êé•Êìç‰Ωú DOM ‰æÜÁ¢∫‰øùÊ®£ÂºèÁîüÊïà
          const app = document.getElementById('app');
          if (app) {
            if (isDarkMode.value) {
              app.classList.remove('light-theme');
              app.style.cssText = '';
            } else {
              app.classList.add('light-theme');
              app.style.setProperty('--bg-primary', '#ffffff');
              app.style.setProperty('--bg-secondary', '#f9fafb');
              app.style.setProperty('--bg-hover', '#f3f4f6');
              app.style.setProperty('--border-color', '#e5e7eb');
              app.style.setProperty('--text-primary', '#111827');
              app.style.setProperty('--text-secondary', '#374151');
              app.style.setProperty('--text-muted', '#6b7280');
            }
          }
        };
        
        // ËºâÂÖ•‰∏ªÈ°å
        const loadTheme = () => {
          const saved = localStorage.getItem('clawchat_theme');
          if (saved) {
            isDarkMode.value = saved === 'dark';
          }
          
          // Á¢∫‰øù DOM Ê®£ÂºèÂêåÊ≠•
          if (!isDarkMode.value) {
            setTimeout(() => {
              const app = document.getElementById('app');
              if (app) {
                app.classList.add('light-theme');
                app.style.setProperty('--bg-primary', '#ffffff');
                app.style.setProperty('--bg-secondary', '#f9fafb');
                app.style.setProperty('--bg-hover', '#f3f4f6');
                app.style.setProperty('--border-color', '#e5e7eb');
                app.style.setProperty('--text-primary', '#111827');
                app.style.setProperty('--text-secondary', '#374151');
                app.style.setProperty('--text-muted', '#6b7280');
              }
            }, 100);
          }
        };
        
        // ËºâÂÖ•ÁïôË®ÄÊùø
        const loadBoard = async () => {
          boardLoading.value = true;
          try {
            const resp = await fetch('/api/board');
            const data = await resp.json();
            boardContent.value = data.content || data.error || 'ÁÑ°Ê≥ïËºâÂÖ•ÁïôË®ÄÊùø';
            boardLastUpdate.value = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          } catch (e) {
            boardContent.value = 'ËºâÂÖ•Â§±Êïó: ' + e.message;
          }
          boardLoading.value = false;
        };
        
        // Ëá™ÂãïÂà∑Êñ∞Ë®àÊôÇÂô®
        const startBoardAutoRefresh = () => {
          if (boardAutoRefreshTimer) clearInterval(boardAutoRefreshTimer);
          if (boardAutoRefresh.value) {
            boardAutoRefreshTimer = setInterval(() => {
              if (currentView.value === 'board') {
                loadBoard();
              }
            }, 30000); // 30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
          }
        };
        
        // Áõ£ËÅΩËá™ÂãïÂà∑Êñ∞ÈñãÈóú
        watch(boardAutoRefresh, () => {
          localStorage.setItem('clawchat_board_autorefresh', boardAutoRefresh.value ? 'true' : 'false');
          startBoardAutoRefresh();
        });
        
        // ËºâÂÖ• Backlog ÁúãÊùø
        const loadBacklog = async () => {
          backlogLoading.value = true;
          try {
            const resp = await fetch('/api/backlog');
            const data = await resp.json();
            backlogContent.value = data.content || data.error || 'ÁÑ°Ê≥ïËºâÂÖ•ÁúãÊùø';
            backlogLastUpdate.value = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          } catch (e) {
            backlogContent.value = 'ËºâÂÖ•Â§±Êïó: ' + e.message;
          }
          backlogLoading.value = false;
        };
        
        // Ëß£Êûê Backlog ÂÖßÂÆπÁÇ∫ÁµêÊßãÂåñË≥áÊñô
        const parseBacklog = (content) => {
          if (!content) return { todo: [], inProgress: [], done: [] };
          
          const result = { todo: [], inProgress: [], done: [] };
          let currentSection = 'todo';
          
          const lines = content.split('\n');
          for (const line of lines) {
            if (line.includes('### üîµ To Do') || line.includes('### To Do')) {
              currentSection = 'todo';
            } else if (line.includes('### üü° In Progress') || line.includes('### In Progress')) {
              currentSection = 'inProgress';
            } else if (line.includes('### ‚úÖ Done') || line.includes('### Done')) {
              currentSection = 'done';
            } else if (line.startsWith('## [')) {
              // Ëß£Êûê‰ªªÂãôÈ†ÖÁõÆ
              const match = line.match(/## \[([^\]]+)\] (.+)/);
              if (match) {
                const task = {
                  status: match[1].trim(),
                  title: match[2].trim(),
                  author: '',
                  date: '',
                  description: '',
                  assignee: ''
                };
                result[currentSection].push(task);
              }
            } else if (line.startsWith('- **ÊèêÂá∫ËÄÖ**:') && result[currentSection].length > 0) {
              const author = line.replace('- **ÊèêÂá∫ËÄÖ**:', '').trim();
              result[currentSection][result[currentSection].length - 1].author = author;
            } else if (line.startsWith('- **Êó•Êúü**:') && result[currentSection].length > 0) {
              const date = line.replace('- **Êó•Êúü**:', '').trim();
              result[currentSection][result[currentSection].length - 1].date = date;
            } else if (line.startsWith('- **ÊèèËø∞**:') && result[currentSection].length > 0) {
              const desc = line.replace('- **ÊèèËø∞**:', '').trim();
              result[currentSection][result[currentSection].length - 1].description = desc;
            } else if (line.startsWith('- **Ë™çÈ†òËÄÖ**:') && result[currentSection].length > 0) {
              const assignee = line.replace('- **Ë™çÈ†òËÄÖ**:', '').trim();
              result[currentSection][result[currentSection].length - 1].assignee = assignee;
            }
          }
          
          return result;
        };
        
        // Backlog Ëß£ÊûêÂæåÁöÑË≥áÊñô
        const backlogData = computed(() => parseBacklog(backlogContent.value));
        
        // ËºâÂÖ•ÊéíÁ®ã
        const loadSchedules = async () => {
          scheduleLoading.value = true;
          try {
            const [schedulesResp, cronsResp] = await Promise.all([
              fetch('/api/schedules'),
              fetch('/api/cron')
            ]);
            const schedulesData = await schedulesResp.json();
            const cronsData = await cronsResp.json();
            
            schedules.value = schedulesData.schedules || [];
            cronJobs.value = cronsData.jobs || [];
          } catch (e) {
            console.error('ËºâÂÖ•ÊéíÁ®ãÂ§±Êïó:', e);
          }
          scheduleLoading.value = false;
        };
        
        // Cron Jobs
        const cronJobs = ref([]);
        
        // Ê†ºÂºèÂåñÊ™îÊ°àÂ§ßÂ∞è
        const formatFileSize = (bytes) => {
          if (!bytes) return '';
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        };
        
        // Ê†ºÂºèÂåñÊôÇÈñì
        const formatTime = (timestamp) => {
          if (!timestamp) return '';
          const date = new Date(timestamp);
          const now = new Date();
          const isToday = date.toDateString() === now.toDateString();
          
          const time = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
          
          if (isToday) {
            return time;
          }
          return `${date.getMonth() + 1}/${date.getDate()} ${time}`;
        };
        
        // Ë§áË£ΩË®äÊÅØ
        const copyMessage = async (content) => {
          try {
            const text = typeof content === 'string' ? content : (content.find?.(c => c.type === 'text')?.text || '');
            await navigator.clipboard.writeText(text);
            showToast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
          } catch (e) {
            console.error('Failed to copy:', e);
            showToast('Ë§áË£ΩÂ§±Êïó', 'error');
          }
        };
        
        // Ë§áË£ΩÊ™îÊ°àÂÖßÂÆπ
        const copyFileContent = async () => {
          try {
            const text = filePreviewImage.value 
              ? ''  // ÂúñÁâáÁÑ°Ê≥ïË§áË£ΩÊñáÂ≠ó
              : (filePreviewContent.value || '');
            await navigator.clipboard.writeText(text);
            showToast('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
          } catch (e) {
            console.error('Failed to copy:', e);
            showToast('Ë§áË£ΩÂ§±Êïó', 'error');
          }
        };
        
        // Ê∏≤ÊüìÂÖßÂÆπ (Markdown for AI)
        const renderContent = (content) => {
          if (!content) return '';
          const text = typeof content === 'string' ? content : (content.find?.(c => c.type === 'text')?.text || '');
          try {
            return marked.parse(text);
          } catch (e) {
            return text;
          }
        };
        
        // ÂàáÊèõÊ™îÊ°àÁÄèË¶ΩÂô®
        const toggleFileBrowser = async () => {
          showFileBrowser.value = !showFileBrowser.value;
          if (showFileBrowser.value && fileBrowserFiles.value.length === 0) {
            await fileBrowserNavigate('');
          }
        };
        
        // ÁÄèË¶ΩÁõÆÈåÑ
        const fileBrowserNavigate = async (path) => {
          fileBrowserLoading.value = true;
          fileBrowserPath.value = path ? path.split('/') : [];
          
          try {
            const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(path)}`;
            const res = await fetch(url);
            const data = await res.json();
            fileBrowserFiles.value = data.files || [];
          } catch (e) {
            console.error('Failed to load files:', e);
            fileBrowserFiles.value = [];
          } finally {
            fileBrowserLoading.value = false;
          }
        };
        
        // ÈñãÂïüÊ™îÊ°à
        const openFile = async (file) => {
          try {
            const fullPath = fileBrowserPath.value.length > 0 
              ? fileBrowserPath.value.join('/') + '/' + file.path 
              : file.path;
            
            // Â¶ÇÊûúÊòØÂúñÁâáÔºåÁõ¥Êé•È°ØÁ§∫ÂúñÁâáÈ†êË¶Ω
            if (isImageFile(file.name)) {
              const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(fullPath)}`;
              const res = await fetch(url);
              const data = await res.json();
              
              if (data.error) {
                showToast(data.error, 'error');
                return;
              }
              
              // ÂúñÁâáÈúÄË¶ÅÁâπÊÆäËôïÁêÜÔºöÁõ¥Êé•È°ØÁ§∫ÂúñÁâá
              filePreviewPath.value = data.path;
              filePreviewImage.value = data.content; // ÈÄôÊòØ base64 Á∑®Á¢ºÁöÑÂúñÁâá
              filePreviewContent.value = 'IMAGE_PLACEHOLDER'; // Ê®ôË®òÁÇ∫ÂúñÁâá
              return;
            }
            
            // ‰∏ÄËà¨Ê™îÊ°à
            const url = `/api/agent/${selectedAgent.value.id}/files?path=${encodeURIComponent(fullPath)}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.error) {
              showToast(data.error, 'error');
              return;
            }
            
            filePreviewPath.value = data.path;
            filePreviewContent.value = data.content;
            filePreviewImage.value = null; // Ê∏ÖÁ©∫ÂúñÁâá
          } catch (e) {
            console.error('Failed to open file:', e);
            showToast('ÁÑ°Ê≥ïÈñãÂïüÊ™îÊ°à', 'error');
          }
        };
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂúñÁâáÊ™îÊ°à
        const isImageFile = (filename) => {
          if (!filename) return false;
          const ext = filename.toLowerCase().split('.').pop();
          return ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp'].includes(ext);
        };
        
        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ Markdown Ê™îÊ°à
        const isMarkdownFile = (filename) => {
          if (!filename) return false;
          const ext = filename.toLowerCase().split('.').pop();
          return ['md', 'markdown', 'mdown', 'mkd'].includes(ext);
        };
        
        // Ê∏≤Êüì Markdown
        const renderMarkdown = (content, baseUrl = '') => {
          if (!content) return '';
          try {
            let parsed = marked.parse(content);
            // ËΩâÊèõÁõ∏Â∞çÈÄ£Áµê ./filename ÁÇ∫ API ÈÄ£ÁµêÔºå‰∏¶Âä†ÂÖ•ÈªûÊìä‰∫ã‰ª∂
            if (baseUrl) {
              parsed = parsed.replace(/href="\.\/([^"]+)"/g, (match, filename) => {
                return `href="#" onclick="event.preventDefault(); window.previewBoardFile('${filename}');" data-board-file="${filename}"`;
              });
            }
            return parsed;
          } catch (e) {
            return content;
          }
        };
        
        // Ê∏≤ÊüìÁïôË®ÄÊùøË®äÊÅØÔºàËá™Ë®ÇÊ†ºÂºèÔºâ
        const renderBoardMessages = (content) => {
          if (!content) return '';
          try {
            // ÂÖàËß£Êûê markdown
            let html = marked.parse(content);
            
            // Ê†ºÂºè: - [YYYY-MM-DD HH:mm] **‰ΩúËÄÖ** Emoji Ë®äÊÅØ
            // ÂÖàËôïÁêÜ li ÂÖÉÁ¥†
            html = html.replace(/<li>([\s\S]*?)<\/li>/g, (match, inner) => {
              // Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´ÊôÇÈñìÊ†ºÂºè
              const timeMatch = inner.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2})\]/);
              if (timeMatch) {
                const time = timeMatch[1];
                // ÁßªÈô§ÊôÇÈñìÊñπÊã¨Ëôü
                let remaining = inner.replace(`[${time}]`, '').trim();
                // ÊèêÂèñ‰ΩúËÄÖÔºàÁ≤óÈ´îÔºâÂíåË®äÊÅØ
                const authorMatch = remaining.match(/\*\*([^*]+)\*\*\s*(.+)/);
                
                if (authorMatch) {
                  const author = authorMatch[1];
                  // ÂàÜÈõ¢ emoji ÂíåÂêçÂ≠ó
                  const authorEmojiMatch = author.match(/^([^\s]+)\s*(.+)$/);
                  let authorHtml = author;
                  if (authorEmojiMatch) {
                    authorHtml = `<span class="emoji">${authorEmojiMatch[1]}</span><span>${authorEmojiMatch[2]}</span>`;
                  }
                  const msgContent = authorMatch[2].trim();
                  return `<li class="board-message">
                    <div class="meta">
                      <div class="author-row">
                        <span class="author">${authorHtml}</span>
                      </div>
                      <span class="time"><i class="bi bi-clock me-1"></i>${time}</span>
                    </div>
                    <div class="content">${msgContent}</div>
                  </li>`;
                }
                // Ê≤íÊúâ‰ΩúËÄÖÔºåÂè™ÊúâÊôÇÈñì
                return `<li class="board-message">
                  <div class="meta">
                    <span class="time"><i class="bi bi-clock me-1"></i>${time}</span>
                  </div>
                  <div class="content">${remaining}</div>
                </li>`;
              }
              return match;
            });
            
            // ËôïÁêÜ p ÂÖÉÁ¥†
            html = html.replace(/<p>([\s\S]*?)<\/p>/g, (match, inner) => {
              const timeMatch = inner.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2})\]/);
              if (timeMatch) {
                const time = timeMatch[1];
                let remaining = inner.replace(`[${time}]`, '').trim();
                const authorMatch = remaining.match(/\*\*([^*]+)\*\*\s*(.+)/);
                
                if (authorMatch) {
                  const author = authorMatch[1];
                  const authorEmojiMatch = author.match(/^([^\s]+)\s*(.+)$/);
                  let authorHtml = author;
                  if (authorEmojiMatch) {
                    authorHtml = `<span class="emoji">${authorEmojiMatch[1]}</span><span>${authorEmojiMatch[2]}</span>`;
                  }
                  const msgContent = authorMatch[2].trim();
                  return `<div class="board-message">
                    <div class="meta">
                      <div class="author-row">
                        <span class="author">${authorHtml}</span>
                      </div>
                      <span class="time"><i class="bi bi-clock me-1"></i>${time}</span>
                    </div>
                    <div class="content">${msgContent}</div>
                  </div>`;
                }
              }
              return match;
            });
            
            return html;
          } catch (e) {
            console.error('Render board error:', e);
            return marked.parse(content);
          }
        };
        
        // È†êË¶ΩÁïôË®ÄÊùøÊ™îÊ°à
        const previewBoardFile = async (filename) => {
          try {
            const resp = await fetch(`/api/board/${filename}`);
            const data = await resp.json();
            if (data.content !== undefined) {
              filePreviewPath.value = filename;
              filePreviewContent.value = data.content;
              filePreviewImage.value = null;
            } else {
              showToast(data.error || 'ÁÑ°Ê≥ïËºâÂÖ•Ê™îÊ°à', 'error');
            }
          } catch (e) {
            showToast('ËºâÂÖ•Â§±Êïó: ' + e.message, 'error');
          }
        };
        
        // ÊéõËºâÂà∞ window ËÆì onclick ÂèØ‰ª•ÂëºÂè´
        window.previewBoardFile = previewBoardFile;
        
        // ÂàáÊèõÊñáÊ™îÂ±ïÈñãÁãÄÊÖã
        const toggleDoc = (docName) => {
          expandedDocs.value[docName] = !expandedDocs.value[docName];
        };
        
        // È°ØÁ§∫ Agent Ë©≥ÊÉÖ
        const showAgentDetail = async (agent) => {
          // ÂèñÂæóË©≥Á¥∞Ë≥áÊñô
          try {
            const res = await fetch(`/api/agent/${agent.id}`);
            const data = await res.json();
            detailView.value = { type: 'agent', data: agent, detail: data };
          } catch (e) {
            console.error(e);
            detailView.value = { type: 'agent', data: agent, detail: null };
          }
        };
        
        // È°ØÁ§∫ Channel Ë©≥ÊÉÖ
        const showChannelDetail = (name, info) => {
          detailView.value = { type: 'channel', name: name, data: info };
        };
        
        // ÂèñÂæóÁÆ°ÁêÜË≥áÊñô
        const fetchManageData = async () => {
          try {
            const [statusRes, agentsRes, channelsRes, sessionsRes] = await Promise.all([
              fetch('/api/status'),
              fetch('/api/agents'),
              fetch('/api/channels'),
              fetch('/api/sessions')
            ]);
            
            const statusData = await statusRes.json();
            const agentsData = await agentsRes.json();
            const channelsData = await channelsRes.json();
            const sessionsData = await sessionsRes.json();
            
            systemStatus.value = statusData.status || 'unknown';
            gatewayInfo.value = statusData.gateway || {};
            ngrokUrl.value = statusData.ngrokUrl || null;
            manageAgents.value = agentsData.agents || [];
            manageChannels.value = channelsData.channels || {};
            manageSessions.value = sessionsData.sessions || [];
          } catch (e) {
            console.error('Failed to fetch manage data:', e);
            systemStatus.value = 'error';
          }
        };
        
        // ÂïüÂãï ngrok
        const startNgrok = async () => {
          try {
            await fetch('/api/ngrok/start');
            // Á≠âÂæÖ‰∏Ä‰∏ãÂÜçÂà∑Êñ∞ÁãÄÊÖã
            setTimeout(() => fetchManageData(), 3000);
          } catch (e) {
            console.error('Failed to start ngrok:', e);
          }
        };
        
        // ÈÅ∏Êìá Agent
        const selectAgent = (agent) => {
          selectedAgent.value = agent;
          showAgentDropdown.value = false;
        };
        
        // ËôïÁêÜÂúñÁâá‰∏äÂÇ≥
        const handleImageUpload = (event) => {
          const files = event.target.files;
          if (!files) return;
          
          for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              uploadedImages.value.push({
                name: file.name,
                type: file.type,
                dataUrl: e.target.result,  // base64 data URL
                preview: e.target.result   // È†êË¶ΩÁî®
              });
            };
            reader.readAsDataURL(file);
          }
          
          // Ê∏ÖÁ©∫ inputÔºåÂÖÅË®±ÈáçË§áÈÅ∏ÊìáÂêå‰∏ÄÊ™îÊ°à
          event.target.value = '';
        };
        
        // ÁßªÈô§ÂúñÁâá
        const removeImage = (index) => {
          uploadedImages.value.splice(index, 1);
        };
        
        // ÊªæÂãïÂà∞Â∫ïÈÉ®ÔºàÂÑ™ÂåñÔºöÊ∏õÂ∞ëÊªæÂãïÊ¨°Êï∏Ôºâ
        let scrollTimeout = null;
        const scrollToBottom = (force = false) => {
          if (scrollTimeout) return; // ÁØÄÊµÅ
          scrollTimeout = setTimeout(() => {
            scrollTimeout = null;
            nextTick(() => {
              if (messagesContainer.value) {
                const container = messagesContainer.value;
                // Â¶ÇÊûúÁî®Êà∂Â∑≤ÊªæÂãïÂà∞ÈôÑËøëÔºåËá™ÂãïÊªæÂãïÂà∞Â∫ïÈÉ®
                const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 200;
                if (force || isNearBottom) {
                  container.scrollTop = container.scrollHeight;
                }
              }
            });
          }, 50); // 50ms debounce
        };
        
        // ÁôºÈÄÅË®äÊÅØ
        const sendMessage = async () => {
          const text = inputText.value.trim();
          if ((!text && uploadedImages.value.length === 0) || isLoading.value) return;
          
          // ËôïÁêÜÁâπÊÆäÊåá‰ª§
          if (text === '/reset') {
            // Âª∫Á´ãÊñ∞ÁöÑ sessionÔºàÊîπËÆä user IDÔºâ
            currentSession.value = `session_${Date.now()}`;
            messages.value = [];
            inputText.value = '';
            
            // Âª∫Á´ãÊñ∞ session Ë®òÈåÑ
            const newSession = { id: currentSession.value, name: 'Êñ∞Â∞çË©±', preview: '', agentId: selectedAgent.value.id };
            sessions.value.unshift(newSession);
            saveSessions();
            return;
          }
          
          // ÊßãÂª∫Ë®äÊÅØÂÖßÂÆπÔºàÊñáÂ≠ó + ÂúñÁâáÔºâ
          let messageContent;
          if (uploadedImages.value.length > 0) {
            // ÊúâÂúñÁâáÔºö‰ΩøÁî®Èô£ÂàóÊ†ºÂºè
            const contentParts = [];
            if (text) {
              contentParts.push({ type: 'text', text: text });
            }
            for (const img of uploadedImages.value) {
              contentParts.push({
                type: 'image_url',
                image_url: { url: img.dataUrl }
              });
            }
            messageContent = contentParts;
          } else {
            messageContent = text;
          }
          
          // Ê∑ªÂä†Áî®Êà∂Ë®äÊÅØÔºàÂåÖÂê´ÂúñÁâáÈ†êË¶ΩÔºâ
          const userMsg = { role: 'user', content: messageContent, timestamp: Date.now() };
          if (uploadedImages.value.length > 0) {
            userMsg.images = uploadedImages.value.map(img => img.preview);  // ÂÑ≤Â≠òÈ†êË¶Ω
          }
          messages.value.push(userMsg);
          
          inputText.value = '';
          uploadedImages.value = [];  // Ê∏ÖÁ©∫‰∏äÂÇ≥ÁöÑÂúñÁâá
          isLoading.value = true;
          scrollToBottom();
          
          try {
            // Âè™ÂèëÈÄÅÂΩìÂâçÁî®Êà∑Ê∂àÊÅØÔºåËÆ© Gateway Á´ØÁÆ°ÁêÜ‰ºöËØùÂéÜÂè≤
            // ÊûÑÂª∫ÂΩìÂâçÁî®Êà∑Ê∂àÊÅØ
            let userMessageContent = messageContent;
            const apiMessages = [];
            
            // Â§ÑÁêÜÂΩìÂâçÁî®Êà∑Ê∂àÊÅØÔºàÊîØÊåÅÂõæÁâáÔºâ
            if (uploadedImages.value.length > 0) {
              const parts = [];
              if (messageContent) {
                parts.push({ type: 'text', text: messageContent });
              }
              for (const img of uploadedImages.value) {
                parts.push({ type: 'image_url', image_url: { url: img.preview } });
              }
              apiMessages.push({ role: 'user', content: parts });
            } else {
              apiMessages.push({ role: 'user', content: messageContent });
            }
            
            console.log('Sending messages:', JSON.stringify(apiMessages, null, 2));
            
            // ‰ΩøÁî® user ÂèÇÊï∞ËÆ© Gateway ÁÆ°ÁêÜ‰ºöËØùÂéÜÂè≤
            const response = await fetch(`/api/chat`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: `openclaw:${selectedAgent.value.id}`,
                messages: apiMessages,
                stream: true,
                user: `${selectedAgent.value.id}_${currentSession.value}`
              })
            });
            
            console.log('Chat response status:', response.status);
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }
            
            // Âª∫Á´ãÁ©∫ÁöÑ assistant Ë®äÊÅØ
            const assistantMsg = { role: 'assistant', content: '', timestamp: Date.now() };
            messages.value.push(assistantMsg);
            
            // ËôïÁêÜ SSE ÊµÅ
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              buffer += decoder.decode(value, { stream: true });
              const lines = buffer.split('\n');
              buffer = lines.pop() || '';
              
              let receivedDone = false;
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = line.slice(6);
                  if (data === '[DONE]') {
                    receivedDone = true;
                    continue;
                  }
                  
                  try {
                    const chunk = JSON.parse(data);
                    const delta = chunk.choices?.[0]?.delta?.content || '';
                    if (delta) {
                      assistantMsg.content += delta;
                      // Âº∑Âà∂Ëß∏Áôº Vue reactivity
                      messages.value = [...messages.value];
                      scrollToBottom();
                    }
                  } catch (e) {}
                }
              }
              if (receivedDone) break;
            }
            
            isLoading.value = false;
          } catch (error) {
            console.error('Error:', error);
            messages.value.push({ 
              role: 'assistant', 
              content: 'Êä±Ê≠âÔºåÁôºÁîüÈåØË™§Ôºö' + error.message,
              error: error.message,
              timestamp: Date.now()
            });
          } finally {
            scrollToBottom();
            // ÂÑ≤Â≠òË®äÊÅØÊ≠∑Âè≤
            saveSessionMessages(currentSession.value, selectedAgent.value.id, messages.value);
          }
        };
        
        // ÂèñÂæó session ÁöÑË®äÊÅØÊ≠∑Âè≤
        const getSessionMessages = (sessionId, agentId) => {
          try {
            const key = `clawchat_${agentId}_${sessionId}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
          } catch (e) {
            return [];
          }
        };
        
        // ÂÑ≤Â≠ò session ÁöÑË®äÊÅØÊ≠∑Âè≤
        const saveSessionMessages = (sessionId, agentId, msgs) => {
          try {
            const key = `clawchat_${agentId}_${sessionId}`;
            localStorage.setItem(key, JSON.stringify(msgs));
          } catch (e) {}
        };
        
        // Ê∏ÖÁ©∫Â∞çË©±
        const clearChat = () => {
          saveSessionMessages(currentSession.value, selectedAgent.value.id, messages.value);
          messages.value = [];
        };
        
        // Session ÂêçÁ®±
        const selectedModelName = computed(() => {
          const model = models.value.find(m => m.id === selectedModel.value);
          return model ? model.name : selectedModel.value;
        });
        
        const currentSessionName = computed(() => {
          const s = sessions.value.find(s => s.id === currentSession.value);
          return s ? s.name : 'Êñ∞Â∞çË©±';
        });
        
        // ÂâµÂª∫Êñ∞Â∞çË©±
        const createNewSession = (agent = null) => {
          // Â¶ÇÊûúÊúâÂÇ≥ÂÖ• agentÔºåÂàáÊç¢Âà∞ËØ• agent
          if (agent) {
            selectAgent(agent);
          }
          
          // ÂÖàÂÑ≤Â≠òÁï∂Ââç session ÁöÑË®äÊÅØ
          const currentMsgs = messages.value;
          if (currentMsgs.length > 0) {
            const lastUserMsg = [...currentMsgs].reverse().find(m => m.role === 'user');
            const preview = lastUserMsg ? lastUserMsg.content.substring(0, 30) : '...';
            const currentS = sessions.value.find(s => s.id === currentSession.value);
            if (currentS) currentS.preview = preview;
            saveSessionMessages(currentSession.value, selectedAgent.value.id, currentMsgs);
          }
          
          const newId = `session_${Date.now()}`;
          sessions.value.unshift({ 
            id: newId, 
            name: 'Êñ∞Â∞çË©±', 
            preview: '',
            agentId: selectedAgent.value.id  // Ë®ò‰ΩèÁï∂Ââç agent
          });
          currentSession.value = newId;
          messages.value = [];
          saveSessions();
          showSessionDropdown.value = false;
          showNewChatModal.value = false;
        };
        
        // ÂàáÊèõÂ∞çË©±
        const switchSession = (session) => {
          // ÂÑ≤Â≠òÁï∂Ââç session ÁöÑË®äÊÅØ
          const currentMsgs = messages.value;
          if (currentMsgs.length > 0) {
            const lastUserMsg = [...currentMsgs].reverse().find(m => m.role === 'user');
            const preview = lastUserMsg ? lastUserMsg.content.substring(0, 30) : '...';
            const currentS = sessions.value.find(s => s.id === currentSession.value);
            if (currentS) currentS.preview = preview;
            saveSessionMessages(currentSession.value, selectedAgent.value.id, currentMsgs);
          }
          
          // ÂàáÊèõÂà∞Ë©≤ session Â∞çÊáâÁöÑ agent
          if (session.agentId) {
            const agent = agents.value.find(a => a.id === session.agentId);
            if (agent) selectedAgent.value = agent;
          }
          
          currentSession.value = session.id;
          // ËºâÂÖ•Ë©≤ session ÁöÑË®äÊÅØÔºà‰ΩøÁî®Ë©≤ session ÁöÑ agentÔºâ
          messages.value = getSessionMessages(session.id, session.agentId || selectedAgent.value.id);
          saveSessions();
          showSessionDropdown.value = false;
        };
        
        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ dropdown
        onMounted(() => {
          // ËºâÂÖ•‰∏ªÈ°å
          loadTheme();
          
          // ÂàùÂßãÂåñ‰∏¶ËºâÂÖ• sessions
          initSessions();
          
          // ËºâÂÖ•ÁïôË®ÄÊùøËá™ÂãïÂà∑Êñ∞Ë®≠ÂÆö
          const savedAutoRefresh = localStorage.getItem('clawchat_board_autorefresh');
          if (savedAutoRefresh !== null) {
            boardAutoRefresh.value = savedAutoRefresh === 'true';
          }
          
          // Á¢∫‰øù session Â∑≤ÂàùÂßãÂåñ
          if (!currentSession.value && sessions.value.length > 0) {
            currentSession.value = sessions.value[0].id;
          }
          
          // ËºâÂÖ•Áï∂Ââç session ÁöÑË®äÊÅØ
          if (currentSession.value && selectedAgent.value) {
            messages.value = getSessionMessages(currentSession.value, selectedAgent.value.id);
          }
          
          document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
              showAgentDropdown.value = false;
              showModelDropdown.value = false;
              showSessionDropdown.value = false;
            }
          });
          
          // Escape ÈçµÈóúÈñâÈ†êË¶Ω
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              filePreviewContent.value = null;
              showMobileMenu.value = false;
              showModelDropdown.value = false;
            }
          });
        });
        
        // ÂàáÊèõ Agent ÊôÇÈ°ØÁ§∫Ê≠°ËøéË®äÊÅØ
        watch(selectedAgent, async () => {
          // ÂÑ≤Â≠ò session ÁöÑ agent ËÆäÊõ¥
          saveSessions();
          
          // Â¶ÇÊûúÊ™îÊ°àÁÄèË¶ΩÂô®ÈñãÂïü‰∏≠ÔºåÈáçÊñ∞ËºâÂÖ•Ê™îÊ°à
          if (showFileBrowser.value) {
            await fileBrowserNavigate('');
          }
          
          if (messages.value.length === 0) {
            // È°ØÁ§∫Ê≠°ËøéË®äÊÅØÂú® messages Èô£Âàó‰∏≠
          }
        });
        
        // ÂàáÊèõÂà∞ÁÆ°ÁêÜÈ†ÅÈù¢ÊôÇÂèñÂæóË≥áÊñô
        watch(currentView, (newView) => {
          if (newView === 'manage') {
            fetchManageData();
          } else if (newView === 'board') {
            loadBoard();
            startBoardAutoRefresh();
          } else if (newView === 'schedule') {
            loadSchedules();
          } else if (newView === 'backlog') {
            loadBacklog();
          }
        });
        
        return {
          agents,
          models,
          selectedAgent,
          selectedModel,
          messages,
          inputText,
          isLoading,
          showAgentDropdown,
          showModelDropdown,
          showMobileMenu,
          showMobileAgentSheet,
          showMobileModelSheet,
          showMobileSessionSheet,
          showMobileFileSheet,
          showNewChatModal,
          selectedModelName,
          toasts,
          showToast,
          showSessionDropdown,
          uploadedImages,
          currentSession,
          sessions,
          currentSessionName,
          messagesContainer,
          currentView,
          boardContent,
          boardLoading,
          boardAutoRefresh,
          boardLastUpdate,
          loadBoard,
          backlogContent,
          backlogLoading,
          backlogLastUpdate,
          backlogData,
          loadBacklog,
          schedules,
          scheduleLoading,
          expandedJob,
          getJobIcon,
          loadSchedules,
          cronJobs,
          systemStatus,
          gatewayInfo,
          ngrokUrl,
          manageAgents,
          manageChannels,
          manageSessions,
          manageSessionsLoading,
          detailView,
          expandedDocs,
          toggleDoc,
          showFileBrowser,
          fileBrowserLoading,
          fileBrowserFiles,
          fileBrowserPath,
          filePreviewContent,
          filePreviewPath,
          filePreviewImage,
          isMarkdownFile,
          isImageFile,
          renderMarkdown,
          formatFileSize,
          toggleFileBrowser,
          fileBrowserNavigate,
          openFile,
          isDarkMode,
          toggleTheme,
          startNgrok,
          showAgentDetail,
          showChannelDetail,
          selectAgent,
          sendMessage,
          clearChat,
          createNewSession,
          switchSession,
          handleImageUpload,
          removeImage,
          formatTime,
          copyMessage,
          copyFileContent,
          renderContent,
          renderBoardMessages
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
